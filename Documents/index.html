è·³è‡³å†…å®¹
å†å²èŠå¤©è®°å½•



ä½ è¯´ï¼š
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Jwc çŸ¥è¯†åº“</title>
    <meta name="theme-color" content="#ffffff">
    
    <!-- å¼•å…¥èµ„æº -->
    <script src="lib/pdfjs/pdf.min.js"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        /* === å˜é‡é…ç½® === */
        :root {
            --primary: #10b981;       
            --primary-bg: rgba(16, 185, 129, 0.08);
            --sidebar-bg: #f8fafc;    
            --content-bg: #ffffff;
            --text-main: #334155;     
            --text-light: #64748b;
            --border: #e2e8f0;
            --sidebar-width: 280px;
            --header-height: 56px;
            --fab-size: 50px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--content-bg);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            overscroll-behavior: none; /* ç¦æ­¢æµè§ˆå™¨é»˜è®¤çš„æ©¡çš®ç­‹æ•ˆæœ */
        }

        .svg-icon { width: 20px; height: 20px; fill: currentColor; transition: transform 0.2s; vertical-align: text-bottom; }
        
        /* ä¾§è¾¹æ  */
        #sidebar {
            width: var(--sidebar-width); height: 100%; background: var(--sidebar-bg);
            border-right: 1px solid var(--border); display: flex; flex-direction: column;
            flex-shrink: 0; z-index: 50; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .sidebar-header {
            height: var(--header-height); padding: 0 20px; display: flex; align-items: center; 
            justify-content: space-between; border-bottom: 1px solid var(--border);
        }
        .app-logo { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .version-badge { font-size: 11px; padding: 2px 8px; border-radius: 10px; background: #e2e8f0; color: #64748b; font-weight: 500; }
        .version-badge.online { background: #dcfce7; color: #15803d; }
        #tree-container { flex: 1; overflow-y: auto; padding: 10px; }

        .node-content {
            padding: 10px 12px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; 
            font-size: 14px; margin-bottom: 2px; transition: background 0.1s;
        }
        .node-content:active { background: #e2e8f0; }
        .node-content.active { background: #fff; color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.05); font-weight: 600; }
        .arrow { margin-left: auto; font-size: 10px; color: #cbd5e1; transition: transform 0.2s; }
        .sub-group { display: none; padding-left: 12px; border-left: 1px solid #e2e8f0; margin-left: 11px; }
        .sub-group.show { display: block; }

        /* ä¸»åŒºåŸŸ */
        #main-area { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; width: 100%; }

        #top-bar {
            height: var(--header-height); border-bottom: 1px solid var(--border); display: flex; 
            align-items: center; justify-content: space-between; padding: 0 12px; 
            background: rgba(255,255,255,0.95); backdrop-filter: blur(8px); z-index: 40; flex-shrink: 0;
        }
        .bar-left { display: flex; align-items: center; gap: 8px; overflow: hidden; }
        .page-title { font-size: 16px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-left: 4px; }
        .tool-btn {
            width: 36px; height: 36px; border-radius: 8px; border: none; background: transparent;
            display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-light);
        }
        .tool-btn:active { background: #f1f5f9; color: var(--primary); }

        #views-container { flex: 1; position: relative; overflow: hidden; }

        /* ç½‘æ ¼è§†å›¾ */
        #grid-view {
            position: absolute; inset: 0; overflow-y: auto; padding: 20px;
            display: grid; gap: 16px; align-content: start;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            background: #fafafa;
        }
        #grid-view.list-mode { display: flex; flex-direction: column; gap: 8px; padding: 16px; }

        .card {
            background: #fff; border: 1px solid var(--border); border-radius: 16px;
            padding: 20px; display: flex; flex-direction: column; align-items: center;
            cursor: pointer; transition: all 0.2s; position: relative;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
        }
        .card:active { transform: scale(0.98); background: #f8fafc; }
        
        .card-icon-box {
            width: 52px; height: 52px; border-radius: 14px;
            display: flex; align-items: center; justify-content: center; margin-bottom: 12px;
        }
        .card-icon-box svg { width: 28px; height: 28px; }
        .card-title { font-size: 14px; font-weight: 600; text-align: center; line-height: 1.4; color: var(--text-main); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .card-meta { font-size: 11px; color: var(--text-light); margin-top: 6px; background: #f1f5f9; padding: 2px 6px; border-radius: 6px; }

        #grid-view.list-mode .card { flex-direction: row; padding: 12px 16px; align-items: center; min-height: auto; }
        #grid-view.list-mode .card-icon-box { width: 40px; height: 40px; margin-bottom: 0; margin-right: 14px; }
        #grid-view.list-mode .card-title { text-align: left; flex: 1; -webkit-line-clamp: 1; }
        #grid-view.list-mode .card-meta { margin-top: 0; background: transparent; }

        /* é˜…è¯»å™¨ */
        #html-view, #pdf-view { position: absolute; inset: 0; background: #fff; display: none; flex-direction: column; }
        iframe { width: 100%; height: 100%; border: none; }
        #pdf-scroll { flex: 1; overflow-y: auto; padding: 20px 0; text-align: center; -webkit-overflow-scrolling: touch; background: #f1f5f9; }
        .pdf-page-canvas { max-width: 100%; height: auto; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); background: white; }

        /* FAB (å·¦ä¸‹è§’) */
        #fab-menu {
            position: fixed; bottom: 24px; left: 24px; 
            width: var(--fab-size); height: var(--fab-size);
            background: var(--primary); color: white; border-radius: 16px;
            box-shadow: 0 8px 16px rgba(16, 185, 129, 0.3);
            display: none; align-items: center; justify-content: center;
            z-index: 90; cursor: pointer; transition: transform 0.2s;
        }
        #fab-menu:active { transform: scale(0.9); }

        .loading {
            position: absolute; inset: 0; background: rgba(255,255,255,0.9);
            display: none; align-items: center; justify-content: center; flex-direction: column;
            z-index: 100; color: var(--primary);
        }

        @media (max-width: 768px) {
            #sidebar { position: fixed; top: 0; left: 0; height: 100%; transform: translateX(-100%); box-shadow: 10px 0 30px rgba(0,0,0,0.1); }
            #sidebar.open { transform: translateX(0); }
            #overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 45; }
            #overlay.show { display: block; }
            #grid-view.list-mode .card-meta { display: none; }
            #fab-menu.visible { display: flex; }
        }
    </style>
</head>
<body>

    <svg style="display:none">
        <symbol id="icon-folder" viewBox="0 0 24 24"><path d="M20,6h-8l-2-2H4C2.9,4,2,4.9,2,6v12c0,1.1,0.9,2,2,2h16c1.1,0,2-0.9,2-2V8C22,6.9,21.1,6,20,6z" fill="currentColor"/></symbol>
        <symbol id="icon-file" viewBox="0 0 24 24"><path d="M14,2H6C4.9,2,4,2.9,4,4v16c0,1.1,0.9,2,2,2h12c1.1,0,2-0.9,2-2V8L14,2z M16,18H8v-2h8V18z M16,14H8v-2h8V14z M13,9V3.5 L18.5,9H13z" fill="currentColor"/></symbol>
        <symbol id="icon-menu" viewBox="0 0 24 24"><path d="M3,18h18v-2H3V18z M3,13h18v-2H3V13z M3,6v2h18V6H3z" fill="currentColor"/></symbol>
        <symbol id="icon-back" viewBox="0 0 24 24"><path d="M20,11H7.83l5.59-5.59L12,4l-8,8l8,8l1.41-1.41L7.83,13H20V11z" fill="currentColor"/></symbol>
    </svg>

    <div id="sidebar">
        <div class="sidebar-header">
            <div class="app-logo">
                <div style="background:var(--primary); width:28px; height:28px; border-radius:6px; display:flex; align-items:center; justify-content:center; margin-right:8px;">
                    <svg class="svg-icon" style="color:white; width:18px; height:18px;"><use href="#icon-folder"></use></svg>
                </div>
                <span>çŸ¥è¯†åº“</span>
            </div>
            <div id="version-badge" class="version-badge">Loading...</div>
        </div>
        <div id="tree-container"></div>
    </div>
    <div id="overlay" onclick="toggleSidebar()"></div>

    <div id="main-area">
        <div id="top-bar">
            <div class="bar-left">
                <!-- è¿”å›æŒ‰é’® -->
                <button id="back-btn" class="tool-btn" style="display:none" onclick="goBack()">
                    <svg class="svg-icon"><use href="#icon-back"></use></svg>
                </button>
                <div class="page-title" id="page-title">é¦–é¡µ</div>
            </div>
            
            <div id="reader-tools" style="display:none; gap:4px;">
                <button class="tool-btn" onclick="zoomPdf(-0.2)">ï¼</button>
                <span id="zoom-val" style="font-size:12px; min-width:32px; text-align:center;">100</span>
                <button class="tool-btn" onclick="zoomPdf(0.2)">ï¼‹</button>
            </div>
        </div>

        <div id="views-container">
            <div id="grid-view" class="visible"></div>
            <div id="html-view"><iframe id="doc-iframe"></iframe></div>
            <div id="pdf-view"><div id="pdf-scroll"><div id="pdf-container"></div></div></div>
            <div id="loading" class="loading">
                <div style="font-size:32px; margin-bottom:10px;">â³</div>
                <div id="loading-text">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <div id="fab-menu" class="visible" onclick="toggleSidebar()">
        <svg class="svg-icon" style="width:24px;height:24px"><use href="#icon-menu"></use></svg>
    </div>

    <script src="data.js"></script>

<script>
    // === é…ç½® ===
    const USER = 'jwchao2020';
    const REPO = 'Jwc_Knowledge_App';
    const BRANCH = 'gh-pages';
    const CDN_ROOT = https://cdn.jsdelivr.net/gh/${USER}/${REPO}@${BRANCH}/Documents/;
    
    let useOnline = false;
    let currentScale = 1.2;
    let historyStack = []; // æ–‡ä»¶å¤¹å†å²
    let currentMode = 'grid'; 

    if (typeof pdfjsLib !== 'undefined') {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'lib/pdfjs/pdf.worker.min.js';
    }

    // === ğŸ¨ æ ·å¼å·¥å‚ ===
    function getTypeStyle(name, isFolder) {
        if (isFolder) return { icon: '#icon-folder', color: '#f59e0b', bg: '#fef3c7' };
        const n = name.toLowerCase();
        if (n.endsWith('.pdf')) return { icon: '#icon-file', color: '#ef4444', bg: '#fee2e2' };
        if (n.endsWith('.html')) return { icon: '#icon-file', color: '#3b82f6', bg: '#dbeafe' };
        if (/\.(jpg|png|svg)$/.test(n)) return { icon: '#icon-file', color: '#a855f7', bg: '#f3e8ff' };
        return { icon: '#icon-file', color: '#64748b', bg: '#f1f5f9' };
    }

    // === 1. åˆå§‹åŒ– & æ›´æ–° ===
    async function init() {
        let data = null;
        if (typeof LOCAL_DATA !== 'undefined') {
            data = parseData(LOCAL_DATA);
            updateBadge('OFFLINE', LOCAL_DATA.version);
        }

        try {
            const res = await fetch(CDN_ROOT + 'data.js?t=' + Date.now());
            if (res.ok) {
                const txt = await res.text();
                const match = txt.match(/const\s+LOCAL_DATA\s*=\s*(\{[\s\S]*\});?/);
                if (match && match[1]) {
                    const remoteData = JSON.parse(match[1]);
                    const localVer = (typeof LOCAL_DATA !== 'undefined') ? Number(LOCAL_DATA.version || 0) : 0;
                    
                    if (Number(remoteData.version) > localVer) {
                        // æœ‰æ–°ç‰ˆæœ¬
                        useOnline = true;
                        data = parseData(remoteData);
                        updateBadge('NEW', remoteData.version);
                    } else {
                        // å·²ç»æ˜¯æœ€æ–°
                        useOnline = false; // ç»§ç»­ç”¨æœ¬åœ°ï¼Œé€Ÿåº¦å¿«
                        updateBadge('LATEST', localVer);
                    }
                }
            }
        } catch(e) {
            console.log('Keep offline');
        }

        if (data) {
            renderSidebar(data);
            renderGrid(data);
        }
    }

    function parseData(rawData) {
        if (Array.isArray(rawData)) return rawData;
        return rawData.tree || rawData.list || rawData.children || [];
    }

    function updateBadge(status, ver) {
        const el = document.getElementById('version-badge');
        let text = 'OFFLINE';
        let cls = '';
        
        if (status === 'NEW') { text = 'å·²æ›´æ–°'; cls = 'online'; }
        else if (status === 'LATEST') { text = 'å·²æ˜¯æœ€æ–°'; cls = 'online'; }
        else { text = 'ç¦»çº¿æ¨¡å¼'; }
        
        el.innerText = ${text} v${(ver||'').toString().slice(-4)};
        if (cls) el.classList.add(cls);
        else el.classList.remove('online');
    }

    // === 2. æ¸²æŸ“å¼•æ“ ===
    function renderSidebar(nodes, container = document.getElementById('tree-container'), level = 0) {
        container.innerHTML = '';
        nodes.forEach(node => {
            const isFolder = node.children && node.children.length > 0;
            const title = node.title || node.name;
            const path = node.path || node.url;

            const item = document.createElement('div');
            item.className = 'tree-node';
            
            const content = document.createElement('div');
            content.className = 'node-content';
            content.style.paddingLeft = ${12 + level * 16}px;
            
            content.innerHTML = 
                <svg class="svg-icon" style="color:${isFolder ? '#f59e0b' : '#64748b'}; margin-right:8px;"><use href="${isFolder ? '#icon-folder' : '#icon-file'}"></use></svg>
                <span style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${title}</span>
                ${isFolder ? <span class="arrow">â–¶</span> : ''}
            ;

            content.onclick = () => {
                if (isFolder) {
                    const arrow = content.querySelector('.arrow');
                    const sub = item.querySelector('.sub-group');
                    sub.classList.toggle('show');
                    arrow.style.transform = sub.classList.contains('show') ? 'rotate(90deg)' : 'rotate(0deg)';
                } else {
                    openFile(path, title);
                    if(window.innerWidth <= 768) toggleSidebar();
                }
            };

            item.appendChild(content);

            if (isFolder) {
                const subGroup = document.createElement('div');
                subGroup.className = 'sub-group';
                item.appendChild(subGroup);
                renderSidebar(node.children, subGroup, level + 1);
            }
            container.appendChild(item);
        });
    }

    function renderGrid(nodes) {
        const grid = document.getElementById('grid-view');
        grid.innerHTML = '';
        currentMode = 'grid';
        switchView('grid-view');
        
        const isRoot = historyStack.length === 0;
        document.getElementById('page-title').innerText = isRoot ? 'çŸ¥è¯†åº“é¦–é¡µ' : 'æ–‡ä»¶å¤¹';
        document.getElementById('back-btn').style.display = isRoot ? 'none' : 'flex';
        
        if (!isRoot) grid.classList.add('list-mode');
        else grid.classList.remove('list-mode');

        // ğŸ—‘ï¸ å·²å½»åº•åˆ é™¤"è¿”å›ä¸Šä¸€çº§"å¡ç‰‡

        nodes.forEach(node => {
            const isFolder = node.children && node.children.length > 0;
            const title = node.title || node.name;
            const path = node.path || node.url;
            const style = getTypeStyle(path, isFolder);

            const card = document.createElement('div');
            card.className = 'card';
            card.onclick = () => {
                if (isFolder) {
                    enterFolder(nodes, node.children);
                } else {
                    openFile(path, title);
                }
            };

            const meta = isFolder ? ${node.children.length} é¡¹ : (path ? path.split('.').pop().toUpperCase() : 'FILE');
            
            card.innerHTML = 
                <div class="card-icon-box" style="background:${style.bg}; color:${style.color}">
                    <svg class="svg-icon" style="width:50%; height:50%"><use href="${style.icon}"></use></svg>
                </div>
                <div class="card-title">${title}</div>
                <div class="card-meta">${meta}</div>
            ;
            grid.appendChild(card);
        });
    }

    // === 3. å¯¼èˆªæ ¸å¿ƒ (è§£å†³åé€€ç›´æ¥é€€å‡ºAppçš„é—®é¢˜) ===
    function enterFolder(parentNodes, childrenNodes) {
        // ğŸŸ¢ å…³é”®ï¼šè¿›å…¥æ–‡ä»¶å¤¹æ—¶å†™å…¥å†å²ï¼Œè¿™æ ·ä¾§æ»‘æ‰‹åŠ¿ä¼šè¢«ç³»ç»Ÿè¯†åˆ«ä¸º"ç½‘é¡µåé€€"ï¼Œè€Œä¸æ˜¯"é€€å‡ºApp"
        history.pushState({ mode: 'folder', depth: historyStack.length + 1 }, null, '#folder');
        historyStack.push(parentNodes);
        renderGrid(childrenNodes);
    }

    function openFile(path, title) {
        if (!path) return;
        const fullPath = useOnline ? (CDN_ROOT + path) : path;
        
        // ğŸŸ¢ å…³é”®ï¼šæ‰“å¼€æ–‡ä»¶ä¹Ÿå†™å…¥å†å²
        history.pushState({ mode: 'reader', file: title }, null, '#reader');
        
        document.getElementById('page-title').innerText = title;
        document.getElementById('back-btn').style.display = 'flex';

        if (path.toLowerCase().endsWith('.pdf')) renderPdf(fullPath);
        else renderHtml(fullPath);
    }

    // ğŸŸ¢ ç›‘å¬ç³»ç»Ÿä¾§æ»‘/ç‰©ç†è¿”å›é”®
    window.addEventListener('popstate', (e) => {
        // å½“ç³»ç»Ÿè§¦å‘åé€€æ—¶ï¼Œæˆ‘ä»¬æ‰‹åŠ¨æ‰§è¡Œ UI çš„å›é€€é€»è¾‘
        if (currentMode !== 'grid') {
            // ä»é˜…è¯»å™¨è¿”å›
            closeReader(true);
        } else if (historyStack.length > 0) {
            // ä»å­æ–‡ä»¶å¤¹è¿”å›
            const parent = historyStack.pop();
            renderGrid(parent); // æ³¨æ„ï¼šrenderGrid å†…éƒ¨ä¼šåˆ¤æ–­ historyStack é•¿åº¦æ¥æ˜¾ç¤ºUIï¼Œä¸éœ€è¦é¢å¤– pop
            // ä¿®æ­£ï¼šrenderGrid åªæ˜¯æ¸²æŸ“ï¼ŒçŠ¶æ€å·²ç»åœ¨ä¸Šé¢ pop äº†ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥æ¸²æŸ“ pop å‡ºæ¥çš„å†…å®¹æ˜¯ä¸å¯¹çš„
            // åº”è¯¥æ˜¯ï¼šæ¸²æŸ“ pop ä¹‹åå‰©ä¸‹çš„æ ˆé¡¶ï¼Œæˆ–è€…...
            // ç®€å•é€»è¾‘ï¼šhistoryStack å­˜çš„æ˜¯"çˆ¶çº§åˆ—è¡¨"ã€‚
            // æ¯”å¦‚ è¿› A -> stack=[Root]ã€‚è¿› B -> stack=[Root, A]ã€‚
            // pop -> æ‹¿åˆ° Aã€‚æ¸²æŸ“ Aã€‚
            // åˆšæ‰ pop å‡ºæ¥çš„æ˜¯ Parentï¼Œç›´æ¥æ¸²æŸ“ Parent æ˜¯å¯¹çš„ã€‚
        }
    });

    function renderHtml(url) {
        currentMode = 'html';
        switchView('html-view');
        document.getElementById('doc-iframe').src = url;
    }

    async function renderPdf(url) {
        currentMode = 'pdf';
        switchView('pdf-view');
        document.getElementById('reader-tools').style.display = 'flex';
        
        const container = document.getElementById('pdf-container');
        container.innerHTML = '';
        const loading = document.getElementById('loading');
        loading.style.display = 'flex';

        try {
            const loadingTask = pdfjsLib.getDocument(url);
            loadingTask.onProgress = (p) => {
                const percent = Math.round((p.loaded / p.total) * 100);
                if(!isNaN(percent)) document.getElementById('loading-text').innerText = åŠ è½½ ${percent}%;
            };
            const pdf = await loadingTask.promise;
            document.getElementById('loading-text').innerText = 'æ¸²æŸ“ä¸­...';

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: currentScale });
                const canvas = document.createElement('canvas');
                canvas.className = 'pdf-page-canvas';
                const context = canvas.getContext('2d');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                
                const clientW = document.getElementById('pdf-scroll').clientWidth - 40;
                const renderScale = clientW / viewport.width;
                if (renderScale < 1) {
                    canvas.style.width = clientW + 'px';
                    canvas.style.height = (viewport.height * renderScale) + 'px';
                }

                container.appendChild(canvas);
                await page.render({ canvasContext: context, viewport: viewport }).promise;
                if (i === 1) loading.style.display = 'none';
                if (i % 5 === 0) await new Promise(r => setTimeout(r, 50));
            }
            loading.style.display = 'none';
        } catch (e) {
            alert('åŠ è½½å¤±è´¥: ' + e.message);
            loading.style.display = 'none';
        }
    }

    function switchView(id) {
        ['grid-view', 'html-view', 'pdf-view'].forEach(v => {
            document.getElementById(v).style.display = (v === id) ? (v === 'grid-view' ? 'grid' : 'flex') : 'none';
        });
        document.getElementById('reader-tools').style.display = 'none';
        const fab = document.getElementById('fab-menu');
        if (id === 'grid-view') fab.classList.add('visible');
        else fab.classList.remove('visible');
    }

    function goBack() {
        // æ‰‹åŠ¨ç‚¹å‡»è¿”å›æŒ‰é’®æ—¶ï¼Œè°ƒç”¨ history.back() è§¦å‘ç³»ç»Ÿçš„ popstate
        // è¿™æ ·å¯ä»¥å¤ç”¨ popstate çš„é€»è¾‘ï¼Œä¿è¯çŠ¶æ€ä¸€è‡´
        history.back();
    }

    function closeReader(isSystemBack) {
        // ä»… UI é‡ç½®ï¼Œhistory å·²ç»åœ¨ popstate é‡Œå¤„ç†äº†ï¼ˆå¦‚æœæ˜¯ç³»ç»Ÿè¿”å›ï¼‰
        currentMode = 'grid';
        switchView('grid-view');
        document.getElementById('doc-iframe').src = '';
        document.getElementById('page-title').innerText = historyStack.length > 0 ? 'æ–‡ä»¶å¤¹' : 'çŸ¥è¯†åº“é¦–é¡µ';
        if (historyStack.length === 0) document.getElementById('back-btn').style.display = 'none';
    }

    window.zoomPdf = function(delta) {
        currentScale += delta;
        if (currentScale < 0.5) currentScale = 0.5;
        document.getElementById('zoom-val').innerText = Math.round(currentScale * 100);
        const canvasList = document.querySelectorAll('.pdf-page-canvas');
        canvasList.forEach(c => {
            c.style.transform = scale(${currentScale});
            c.style.transformOrigin = 'top center';
            c.style.marginBottom = ${20 * currentScale}px;
        });
    }

    window.toggleSidebar = function() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        sidebar.classList.toggle('open');
        overlay.classList.toggle('show');
    }

    init();
</script>
</body>
</html>

è¿™ä¸ªå­˜åœ¨bug,å°†è¿™ä¸ªä¼˜åŒ–ä¸€ä¸‹,è¯´æ˜æ˜¯ä»€ä¹ˆbugï¼š
ChatGPT è¯´ï¼š

å·²æ€è€ƒ 2m 15s
ä½ è¿™ä»½ä»£ç é‡Œæœ€æ˜æ˜¾çš„â€œçœŸ bugâ€æœ‰ä¸¤ä¸ªï¼ˆä¸€ä¸ªä¼šç›´æ¥å¯¼è‡´ç•Œé¢è¡Œä¸ºä¸å¯¹ï¼Œä¸€ä¸ªä¼šå¯¼è‡´åœ¨çº¿æ›´æ–°æ°¸è¿œå¤±æ•ˆï¼‰ï¼Œå¦å¤–è¿˜æœ‰ä¸€ä¸ªâ€œæ€§èƒ½/ç¨³å®šæ€§ bugâ€ï¼ˆPDF åå¤æ‰“å¼€ä¼šè¶Šæ¥è¶Šå¡ï¼‰ã€‚

âœ… Bug 1ï¼šå­æ–‡ä»¶å¤¹çš„ list-mode æ ¹æœ¬ä¸ä¼šç”Ÿæ•ˆï¼ˆå¸ƒå±€ä¸€ç›´æ˜¯ç½‘æ ¼ï¼‰
ç°è±¡
ä½ å†™äº†ï¼š

#grid-view.list-mode { display: flex; ... }
å¹¶ä¸”åœ¨å­æ–‡ä»¶å¤¹é‡Œï¼š

grid.classList.add('list-mode');
ä½†é¡µé¢ä»ç„¶æ˜¯ grid ç½‘æ ¼ï¼Œè€Œä¸æ˜¯åˆ—è¡¨ã€‚

åŸå› ï¼ˆå…³é”®ç‚¹ï¼‰
ä½ åœ¨ switchView() é‡Œç»™ #grid-view å†™äº†è¡Œå†…æ ·å¼ï¼š

document.getElementById('grid-view').style.display = 'grid';
è¡Œå†…æ ·å¼ä¼˜å…ˆçº§é«˜äº CSS classï¼Œæ‰€ä»¥ .list-mode { display:flex } æ°¸è¿œç›–ä¸è¿‡ style="display:grid"ã€‚

ä¿®å¤æ€è·¯
switchView() ä¸è¦å†ç¡¬å†™ grid-view çš„ displayï¼Œè®© CSS å†³å®šï¼ˆgrid æˆ– flexï¼‰ã€‚

âœ… Bug 2ï¼šåœ¨çº¿ data.js ç‰ˆæœ¬æ›´æ–°å‡ ä¹å¿…å®šå¤±è´¥ï¼ˆä¸€ç›´èµ°ç¦»çº¿ï¼‰
ç°è±¡
ä½ æœŸæœ›ï¼šæ‹‰å– jsdelivr ä¸Šçš„ data.jsï¼Œå¯¹æ¯”ç‰ˆæœ¬å·ï¼Œæœ‰æ–°ç‰ˆæœ¬å°± useOnline = trueã€‚

åŸå› 
ä½ ç”¨ï¼š

const remoteData = JSON.parse(match[1]);
ä½† data.js é‡Œ const LOCAL_DATA = {...} é€šå¸¸ä¸æ˜¯ä¸¥æ ¼ JSONï¼ˆå¯èƒ½ key æ²¡å¼•å·ã€å¯èƒ½æœ‰æ³¨é‡Šã€å¯èƒ½æœ‰å°¾é€—å·ç­‰ï¼‰ï¼Œæ‰€ä»¥ JSON.parse å¾ˆå®¹æ˜“ç›´æ¥æŠ›å¼‚å¸¸ï¼Œè¢«å¤–å±‚ catch åƒæ‰ï¼Œç„¶åä½ å°±ä¸€ç›´ Keep offlineã€‚

ä¿®å¤æ€è·¯
æŠŠ {...} å½“æˆ JS å¯¹è±¡å­—é¢é‡è§£æï¼ˆè€Œä¸æ˜¯ JSONï¼‰ï¼Œæ¯”å¦‚ç”¨ Function è¿”å›å¯¹è±¡ã€‚

âš ï¸ æ€§èƒ½/ç¨³å®šæ€§é—®é¢˜ï¼šPDF æ‰“å¼€/ç¼©æ”¾ä¼šè¶Šæ¥è¶Šå¡ã€å å†…å­˜
åŸå› 
æ¯æ¬¡ renderPdf() éƒ½æ¸²æŸ“æ‰€æœ‰é¡µ canvasï¼Œä¸”ä¸å–æ¶ˆä¸Šä¸€æ¬¡ä»»åŠ¡ã€‚

closeReader() æ²¡æ¸…ç† pdf-containerï¼ˆcanvas ç•™ç€å å†…å­˜ï¼‰ã€‚

zoomPdf() ç”¨ CSS transform æ”¾å¤§ canvasï¼Œä¼šç³Šã€ä¸”å¸ƒå±€/å®½åº¦è®¡ç®—è¶Šæ¥è¶Šæ€ªï¼›æ›´åˆç†æ˜¯ç¼©æ”¾åé‡æ–°æ¸²æŸ“ï¼ˆå¯ä»¥åš debounceï¼‰ã€‚

âœ… ç›´æ¥ç»™ä½ ä¸€ä»½â€œå¯ç²˜è´´æ›¿æ¢â€çš„ä¿®å¤è¡¥ä¸ï¼ˆåªæ”¹ JS å‡½æ•°ï¼Œä¸åŠ¨ä½ çš„ç»“æ„ï¼‰
æŠŠä¸‹é¢ä»£ç ç²˜è´´åˆ°ä½ ç°æœ‰ <script> ä¸­ï¼ˆæ›¿æ¢åŒåå‡½æ•°/æ–°å¢å˜é‡å³å¯ï¼‰ã€‚

// ====== æ–°å¢ï¼šPDF çŠ¶æ€ï¼ˆæ”¾åœ¨å…¨å±€å˜é‡åŒºåŸŸï¼‰======
let currentPdfDoc = null;
let currentPdfUrl = '';
let pdfLoadingTask = null;
let pdfRenderSeq = 0;     // ç”¨äºä¸­æ–­æ—§æ¸²æŸ“
let zoomTimer = null;

// ====== ä¿®å¤ 1ï¼šswitchView ä¸è¦å¼ºè¡Œç»™ grid-view å†™ display:gridï¼ˆå¦åˆ™ list-mode æ°¸è¿œå¤±æ•ˆï¼‰======
function switchView(id) {
  const grid = document.getElementById('grid-view');
  const html = document.getElementById('html-view');
  const pdf  = document.getElementById('pdf-view');

  // å…ˆå…¨éƒ¨éšè—
  grid.style.display = 'none';
  html.style.display = 'none';
  pdf.style.display  = 'none';

  // reader-tools é»˜è®¤éšè—
  document.getElementById('reader-tools').style.display = 'none';

  // æ˜¾ç¤ºç›®æ ‡
  if (id === 'grid-view') {
    // âœ… å…³é”®ï¼šè®© CSS å†³å®šæ˜¾ç¤ºæ–¹å¼ï¼ˆgrid æˆ– flexï¼‰ï¼Œä¸è¦å†™æ­» grid
    grid.style.display = '';
  } else if (id === 'html-view') {
    html.style.display = 'flex';
  } else if (id === 'pdf-view') {
    pdf.style.display = 'flex';
  }

  // FAB
  const fab = document.getElementById('fab-menu');
  if (id === 'grid-view') fab.classList.add('visible');
  else fab.classList.remove('visible');
}

// ====== ä¿®å¤ 1 é…å¥—ï¼šrenderGrid è°ƒæ•´é¡ºåºï¼šå…ˆåŠ  list-mode å† switchView ======
function renderGrid(nodes) {
  const grid = document.getElementById('grid-view');
  grid.innerHTML = '';
  currentMode = 'grid';

  const isRoot = historyStack.length === 0;
  document.getElementById('page-title').innerText = isRoot ? 'çŸ¥è¯†åº“é¦–é¡µ' : 'æ–‡ä»¶å¤¹';
  document.getElementById('back-btn').style.display = isRoot ? 'none' : 'flex';

  // âœ… å…ˆåˆ‡æ¢ classï¼Œå†æ˜¾ç¤ºï¼ˆé¿å… display è¢«è¦†ç›–ï¼‰
  if (!isRoot) grid.classList.add('list-mode');
  else grid.classList.remove('list-mode');

  switchView('grid-view');

  nodes.forEach(node => {
    const isFolder = node.children && node.children.length > 0;
    const title = node.title || node.name;
    const path = node.path || node.url;
    const style = getTypeStyle(path, isFolder);

    const card = document.createElement('div');
    card.className = 'card';
    card.onclick = () => {
      if (isFolder) enterFolder(nodes, node.children);
      else openFile(path, title);
    };

    const meta = isFolder ? `${node.children.length} é¡¹` : (path ? path.split('.').pop().toUpperCase() : 'FILE');

    card.innerHTML = `
      <div class="card-icon-box" style="background:${style.bg}; color:${style.color}">
        <svg class="svg-icon" style="width:50%; height:50%"><use href="${style.icon}"></use></svg>
      </div>
      <div class="card-title">${title}</div>
      <div class="card-meta">${meta}</div>
    `;
    grid.appendChild(card);
  });
}

// ====== ä¿®å¤ 2ï¼šåœ¨çº¿ data.js çš„è§£æä¸è¦ç”¨ JSON.parseï¼ˆä¼šå¤±è´¥ï¼‰ï¼Œæ”¹ä¸ºè§£æ JS å¯¹è±¡å­—é¢é‡ ======
function parseRemoteLocalDataFromJs(txt) {
  const match = txt.match(/const\s+LOCAL_DATA\s*=\s*([\s\S]*?);\s*$/m);
  if (!match || !match[1]) return null;

  // âœ… æŠŠå¯¹è±¡å­—é¢é‡å½“ JS è¿è¡Œï¼Œè¿”å›å¯¹è±¡ï¼ˆæ¯” JSON.parse ç¨³å®šï¼‰
  try {
    return Function('"use strict"; return (' + match[1] + ')')();
  } catch (e) {
    console.warn('remote LOCAL_DATA parse failed:', e);
    return null;
  }
}

// ä½ åŸ init() é‡Œ fetch æˆåŠŸåçš„é‚£æ®µï¼Œæ›¿æ¢æˆä¸‹é¢é€»è¾‘
async function init() {
  let data = null;

  // æœ¬åœ°
  if (typeof LOCAL_DATA !== 'undefined') {
    data = parseData(LOCAL_DATA);
    updateBadge('OFFLINE', LOCAL_DATA.version);
  }

  // åœ¨çº¿ç‰ˆæœ¬æ£€æŸ¥
  try {
    const res = await fetch(CDN_ROOT + 'data.js?t=' + Date.now());
    if (res.ok) {
      const txt = await res.text();
      const remoteData = parseRemoteLocalDataFromJs(txt);

      if (remoteData) {
        const localVer = (typeof LOCAL_DATA !== 'undefined') ? Number(LOCAL_DATA.version || 0) : 0;
        const remoteVer = Number(remoteData.version || 0);

        if (remoteVer > localVer) {
          useOnline = true;
          data = parseData(remoteData);
          updateBadge('NEW', remoteVer);
        } else {
          useOnline = false;
          updateBadge('LATEST', localVer);
        }
      }
    }
  } catch (e) {
    console.log('Keep offline');
  }

  if (data) {
    renderSidebar(data);
    renderGrid(data);
  }
}

// ====== æ€§èƒ½ä¿®å¤ï¼šå…³é—­é˜…è¯»å™¨æ—¶æ¸…ç† PDFï¼ˆä¸ç„¶ canvas è¶Šç§¯è¶Šå¤šï¼‰======
function closeReader(isSystemBack) {
  currentMode = 'grid';
  switchView('grid-view');

  // æ¸…ç† iframe
  document.getElementById('doc-iframe').src = '';

  // âœ… æ¸…ç† PDFï¼ˆå…³é”®ï¼‰
  document.getElementById('pdf-container').innerHTML = '';
  document.getElementById('reader-tools').style.display = 'none';

  // å–æ¶ˆä¸Šä¸€æ¬¡åŠ è½½ä»»åŠ¡
  try { pdfLoadingTask && pdfLoadingTask.destroy && pdfLoadingTask.destroy(); } catch {}
  pdfLoadingTask = null;
  currentPdfDoc = null;
  currentPdfUrl = '';

  document.getElementById('page-title').innerText = historyStack.length > 0 ? 'æ–‡ä»¶å¤¹' : 'çŸ¥è¯†åº“é¦–é¡µ';
  if (historyStack.length === 0) document.getElementById('back-btn').style.display = 'none';
}

// ====== PDF æ¸²æŸ“ï¼šæ”¯æŒä¸­æ–­æ—§æ¸²æŸ“ + è®°å½•å½“å‰ url ======
async function renderPdf(url) {
  currentMode = 'pdf';
  switchView('pdf-view');
  document.getElementById('reader-tools').style.display = 'flex';

  currentPdfUrl = url;

  // ä¸­æ–­æ—§ä»»åŠ¡
  pdfRenderSeq++;
  const mySeq = pdfRenderSeq;

  const container = document.getElementById('pdf-container');
  container.innerHTML = '';

  const loading = document.getElementById('loading');
  loading.style.display = 'flex';

  try {
    // æ¸…ç†æ—§ doc
    if (currentPdfDoc) {
      try { await currentPdfDoc.destroy(); } catch {}
      currentPdfDoc = null;
    }
    if (pdfLoadingTask) {
      try { await pdfLoadingTask.destroy(); } catch {}
      pdfLoadingTask = null;
    }

    pdfLoadingTask = pdfjsLib.getDocument(url);
    pdfLoadingTask.onProgress = (p) => {
      const percent = Math.round((p.loaded / p.total) * 100);
      if (!isNaN(percent)) document.getElementById('loading-text').innerText = `åŠ è½½ ${percent}%`;
    };

    const pdf = await pdfLoadingTask.promise;
    if (mySeq !== pdfRenderSeq) return; // âœ… è¢«æ–°ä»»åŠ¡æ‰“æ–­
    currentPdfDoc = pdf;

    document.getElementById('loading-text').innerText = 'æ¸²æŸ“ä¸­...';

    const scrollEl = document.getElementById('pdf-scroll');
    const clientW = scrollEl.clientWidth - 40;

    for (let i = 1; i <= pdf.numPages; i++) {
      if (mySeq !== pdfRenderSeq) return; // âœ… è¢«æ–°ä»»åŠ¡æ‰“æ–­

      const page = await pdf.getPage(i);
      const viewport = page.getViewport({ scale: currentScale });

      const canvas = document.createElement('canvas');
      canvas.className = 'pdf-page-canvas';
      const ctx = canvas.getContext('2d');

      canvas.width = viewport.width;
      canvas.height = viewport.height;

      // é€‚é…å®½åº¦ï¼ˆä¿æŒä½ åŸæ¥çš„é€»è¾‘ï¼Œä½†æ›´ç¨³å®šï¼‰
      const fitScale = clientW / viewport.width;
      if (fitScale < 1) {
        canvas.style.width = clientW + 'px';
        canvas.style.height = (viewport.height * fitScale) + 'px';
      }

      container.appendChild(canvas);
      await page.render({ canvasContext: ctx, viewport }).promise;

      if (i === 1) loading.style.display = 'none';
      if (i % 5 === 0) await new Promise(r => setTimeout(r, 20));
    }

    loading.style.display = 'none';
  } catch (e) {
    loading.style.display = 'none';
    alert('åŠ è½½å¤±è´¥: ' + e.message);
  }
}

// ====== ç¼©æ”¾ï¼šä¸è¦ç”¨ CSS transform ç›´æ¥æ‹‰ä¼¸ï¼ˆä¼šç³Šï¼‰ï¼Œæ”¹ä¸º debounce é‡æ–°æ¸²æŸ“ ======
window.zoomPdf = function(delta) {
  currentScale += delta;
  if (currentScale < 0.5) currentScale = 0.5;

  document.getElementById('zoom-val').innerText = Math.round(currentScale * 100);

  // åªåœ¨ PDF æ¨¡å¼ä¸‹é‡æ¸²æŸ“
  if (currentMode !== 'pdf' || !currentPdfUrl) return;

  clearTimeout(zoomTimer);
  zoomTimer = setTimeout(() => {
    renderPdf(currentPdfUrl);
  }, 120);
};
ä½ æ”¹å®Œåä¼šç«‹åˆ»å¾—åˆ°è¿™äº›æ”¶ç›Š
âœ… å­æ–‡ä»¶å¤¹è¿›å…¥å list-mode ä¼šçœŸçš„å˜æˆåˆ—è¡¨

âœ… jsdelivr ä¸Šçš„ data.js ç‰ˆæœ¬æ›´æ–°èƒ½æ­£å¸¸å¯¹æ¯”å¹¶åˆ‡æ¢åœ¨çº¿

âœ… PDF åå¤æ‰“å¼€/ç¼©æ”¾ ä¸ä¼šè¶Šç”¨è¶Šå¡ã€å†…å­˜æš´æ¶¨

âœ… ç¼©æ”¾æ¸…æ™°åº¦æ›´å¥½ï¼ˆé‡æ–°æ¸²æŸ“è€Œä¸æ˜¯ transform æ”¾å¤§ï¼‰

å¦‚æœä½ å‘Šè¯‰æˆ‘â€œå…·ä½“å“ªä¸ª bug çš„ç°è±¡â€ï¼ˆæ¯”å¦‚ï¼šè¿›å…¥æ–‡ä»¶å¤¹è¿˜æ˜¯ç½‘æ ¼ï¼Ÿåœ¨çº¿æ›´æ–°ä¸€ç›´æ˜¾ç¤ºç¦»çº¿ï¼Ÿè¿”å›é”®é€€å‡º Appï¼ŸPDF ç¼©æ”¾æ¨¡ç³Šï¼Ÿï¼‰ï¼Œæˆ‘è¿˜èƒ½æŠŠ history.pushState/popstate çš„çŠ¶æ€ç®¡ç†å†è¿›ä¸€æ­¥æ•´ç†æˆå®Œå…¨ä¸ä¹±çš„çŠ¶æ€æœºç‰ˆæœ¬ï¼ˆæ›´ç¨³ï¼Œå®‰å“ä¾§æ»‘/ç‰©ç†è¿”å›é”®ä½“éªŒæ›´åƒåŸç”Ÿ Appï¼‰ã€‚

ä½ è¯´ï¼š
ç»™å‡ºä¿®æ”¹åçš„å®Œæ•´ç‰ˆæœ¬
ChatGPT è¯´ï¼š

å·²æ€è€ƒ 51s
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Jwc çŸ¥è¯†åº“</title>
  <meta name="theme-color" content="#ffffff" />

  <!-- å¼•å…¥èµ„æº -->
  <script src="lib/pdfjs/pdf.min.js"></script>
  <script id="MathJax-script" async
          src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    /* === å˜é‡é…ç½® === */
    :root {
      --primary: #10b981;
      --primary-bg: rgba(16, 185, 129, 0.08);
      --sidebar-bg: #f8fafc;
      --content-bg: #ffffff;
      --text-main: #334155;
      --text-light: #64748b;
      --border: #e2e8f0;
      --sidebar-width: 280px;
      --header-height: 56px;
      --fab-size: 50px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: var(--content-bg);
      color: var(--text-main);
      margin: 0;
      height: 100vh;
      overflow: hidden;
      display: flex;
      overscroll-behavior: none; /* ç¦æ­¢æµè§ˆå™¨é»˜è®¤çš„æ©¡çš®ç­‹æ•ˆæœ */
    }

    .svg-icon { width: 20px; height: 20px; fill: currentColor; transition: transform 0.2s; vertical-align: text-bottom; }

    /* ä¾§è¾¹æ  */
    #sidebar {
      width: var(--sidebar-width); height: 100%; background: var(--sidebar-bg);
      border-right: 1px solid var(--border); display: flex; flex-direction: column;
      flex-shrink: 0; z-index: 50; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .sidebar-header {
      height: var(--header-height); padding: 0 20px; display: flex; align-items: center;
      justify-content: space-between; border-bottom: 1px solid var(--border);
    }
    .app-logo { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
    .version-badge { font-size: 11px; padding: 2px 8px; border-radius: 10px; background: #e2e8f0; color: #64748b; font-weight: 500; }
    .version-badge.online { background: #dcfce7; color: #15803d; }
    #tree-container { flex: 1; overflow-y: auto; padding: 10px; }

    .node-content {
      padding: 10px 12px; border-radius: 8px; cursor: pointer; display: flex; align-items: center;
      font-size: 14px; margin-bottom: 2px; transition: background 0.1s;
    }
    .node-content:active { background: #e2e8f0; }
    .node-content.active { background: #fff; color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.05); font-weight: 600; }
    .arrow { margin-left: auto; font-size: 10px; color: #cbd5e1; transition: transform 0.2s; }
    .sub-group { display: none; padding-left: 12px; border-left: 1px solid #e2e8f0; margin-left: 11px; }
    .sub-group.show { display: block; }

    /* ä¸»åŒºåŸŸ */
    #main-area { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; width: 100%; }

    #top-bar {
      height: var(--header-height); border-bottom: 1px solid var(--border); display: flex;
      align-items: center; justify-content: space-between; padding: 0 12px;
      background: rgba(255,255,255,0.95); backdrop-filter: blur(8px); z-index: 40; flex-shrink: 0;
    }
    .bar-left { display: flex; align-items: center; gap: 8px; overflow: hidden; }
    .page-title { font-size: 16px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-left: 4px; }
    .tool-btn {
      width: 36px; height: 36px; border-radius: 8px; border: none; background: transparent;
      display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-light);
    }
    .tool-btn:active { background: #f1f5f9; color: var(--primary); }

    #views-container { flex: 1; position: relative; overflow: hidden; }

    /* ç½‘æ ¼è§†å›¾ */
    #grid-view {
      position: absolute; inset: 0; overflow-y: auto; padding: 20px;
      display: grid; gap: 16px; align-content: start;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      background: #fafafa;
    }
    #grid-view.list-mode { display: flex; flex-direction: column; gap: 8px; padding: 16px; }

    .card {
      background: #fff; border: 1px solid var(--border); border-radius: 16px;
      padding: 20px; display: flex; flex-direction: column; align-items: center;
      cursor: pointer; transition: all 0.2s; position: relative;
      box-shadow: 0 1px 2px rgba(0,0,0,0.03);
    }
    .card:active { transform: scale(0.98); background: #f8fafc; }

    .card-icon-box {
      width: 52px; height: 52px; border-radius: 14px;
      display: flex; align-items: center; justify-content: center; margin-bottom: 12px;
    }
    .card-icon-box svg { width: 28px; height: 28px; }
    .card-title { font-size: 14px; font-weight: 600; text-align: center; line-height: 1.4; color: var(--text-main); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .card-meta { font-size: 11px; color: var(--text-light); margin-top: 6px; background: #f1f5f9; padding: 2px 6px; border-radius: 6px; }

    #grid-view.list-mode .card { flex-direction: row; padding: 12px 16px; align-items: center; min-height: auto; }
    #grid-view.list-mode .card-icon-box { width: 40px; height: 40px; margin-bottom: 0; margin-right: 14px; }
    #grid-view.list-mode .card-title { text-align: left; flex: 1; -webkit-line-clamp: 1; }
    #grid-view.list-mode .card-meta { margin-top: 0; background: transparent; }

    /* é˜…è¯»å™¨ */
    #html-view, #pdf-view { position: absolute; inset: 0; background: #fff; display: none; flex-direction: column; }
    iframe { width: 100%; height: 100%; border: none; }
    #pdf-scroll { flex: 1; overflow-y: auto; padding: 20px 0; text-align: center; -webkit-overflow-scrolling: touch; background: #f1f5f9; }
    .pdf-page-canvas { max-width: 100%; height: auto; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); background: white; }

    /* FAB (å·¦ä¸‹è§’) */
    #fab-menu {
      position: fixed; bottom: 24px; left: 24px;
      width: var(--fab-size); height: var(--fab-size);
      background: var(--primary); color: white; border-radius: 16px;
      box-shadow: 0 8px 16px rgba(16, 185, 129, 0.3);
      display: none; align-items: center; justify-content: center;
      z-index: 90; cursor: pointer; transition: transform 0.2s;
    }
    #fab-menu:active { transform: scale(0.9); }

    .loading {
      position: absolute; inset: 0; background: rgba(255,255,255,0.9);
      display: none; align-items: center; justify-content: center; flex-direction: column;
      z-index: 100; color: var(--primary);
    }

    @media (max-width: 768px) {
      #sidebar { position: fixed; top: 0; left: 0; height: 100%; transform: translateX(-100%); box-shadow: 10px 0 30px rgba(0,0,0,0.1); }
      #sidebar.open { transform: translateX(0); }
      #overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 45; }
      #overlay.show { display: block; }
      #grid-view.list-mode .card-meta { display: none; }
      #fab-menu.visible { display: flex; }
    }
  </style>
</head>

<body>
  <svg style="display:none">
    <symbol id="icon-folder" viewBox="0 0 24 24"><path d="M20,6h-8l-2-2H4C2.9,4,2,4.9,2,6v12c0,1.1,0.9,2,2,2h16c1.1,0,2-0.9,2-2V8C22,6.9,21.1,6,20,6z" fill="currentColor"/></symbol>
    <symbol id="icon-file" viewBox="0 0 24 24"><path d="M14,2H6C4.9,2,4,2.9,4,4v16c0,1.1,0.9,2,2,2h12c1.1,0,2-0.9,2-2V8L14,2z M16,18H8v-2h8V18z M16,14H8v-2h8V14z M13,9V3.5 L18.5,9H13z" fill="currentColor"/></symbol>
    <symbol id="icon-menu" viewBox="0 0 24 24"><path d="M3,18h18v-2H3V18z M3,13h18v-2H3V13z M3,6v2h18V6H3z" fill="currentColor"/></symbol>
    <symbol id="icon-back" viewBox="0 0 24 24"><path d="M20,11H7.83l5.59-5.59L12,4l-8,8l8,8l1.41-1.41L7.83,13H20V11z" fill="currentColor"/></symbol>
  </svg>

  <div id="sidebar">
    <div class="sidebar-header">
      <div class="app-logo">
        <div style="background:var(--primary); width:28px; height:28px; border-radius:6px; display:flex; align-items:center; justify-content:center; margin-right:8px;">
          <svg class="svg-icon" style="color:white; width:18px; height:18px;"><use href="#icon-folder"></use></svg>
        </div>
        <span>çŸ¥è¯†åº“</span>
      </div>
      <div id="version-badge" class="version-badge">Loading...</div>
    </div>
    <div id="tree-container"></div>
  </div>
  <div id="overlay" onclick="toggleSidebar()"></div>

  <div id="main-area">
    <div id="top-bar">
      <div class="bar-left">
        <button id="back-btn" class="tool-btn" style="display:none" onclick="goBack()">
          <svg class="svg-icon"><use href="#icon-back"></use></svg>
        </button>
        <div class="page-title" id="page-title">é¦–é¡µ</div>
      </div>

      <div id="reader-tools" style="display:none; gap:4px;">
        <button class="tool-btn" onclick="zoomPdf(-0.2)">ï¼</button>
        <span id="zoom-val" style="font-size:12px; min-width:32px; text-align:center;">100</span>
        <button class="tool-btn" onclick="zoomPdf(0.2)">ï¼‹</button>
      </div>
    </div>

    <div id="views-container">
      <div id="grid-view" class="visible"></div>
      <div id="html-view"><iframe id="doc-iframe"></iframe></div>
      <div id="pdf-view"><div id="pdf-scroll"><div id="pdf-container"></div></div></div>
      <div id="loading" class="loading">
        <div style="font-size:32px; margin-bottom:10px;">â³</div>
        <div id="loading-text">åŠ è½½ä¸­...</div>
      </div>
    </div>
  </div>

  <div id="fab-menu" class="visible" onclick="toggleSidebar()">
    <svg class="svg-icon" style="width:24px;height:24px"><use href="#icon-menu"></use></svg>
  </div>

  <script src="data.js"></script>

  <script>
    // === é…ç½® ===
    const USER = 'jwchao2020';
    const REPO = 'Jwc_Knowledge_App';
    const BRANCH = 'gh-pages';
    const CDN_ROOT = `https://cdn.jsdelivr.net/gh/${USER}/${REPO}@${BRANCH}/Documents/`;

    let useOnline = false;
    let currentScale = 1.2;
    let historyStack = []; // æ–‡ä»¶å¤¹å†å²
    let currentMode = 'grid';

    // ====== PDF çŠ¶æ€ï¼ˆä¿®å¤ï¼šä¸­æ–­æ—§æ¸²æŸ“ + é˜²å†…å­˜ä¸Šæ¶¨ + ç¼©æ”¾é‡æ¸²æŸ“ï¼‰======
    let currentPdfDoc = null;
    let currentPdfUrl = '';
    let pdfLoadingTask = null;
    let pdfRenderSeq = 0;
    let zoomTimer = null;

    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'lib/pdfjs/pdf.worker.min.js';
    }

    // === ğŸ¨ æ ·å¼å·¥å‚ ===
    function getTypeStyle(name, isFolder) {
      if (isFolder) return { icon: '#icon-folder', color: '#f59e0b', bg: '#fef3c7' };
      const n = (name || '').toLowerCase();
      if (n.endsWith('.pdf')) return { icon: '#icon-file', color: '#ef4444', bg: '#fee2e2' };
      if (n.endsWith('.html')) return { icon: '#icon-file', color: '#3b82f6', bg: '#dbeafe' };
      if (/\.(jpg|png|svg)$/.test(n)) return { icon: '#icon-file', color: '#a855f7', bg: '#f3e8ff' };
      return { icon: '#icon-file', color: '#64748b', bg: '#f1f5f9' };
    }

    // === æ•°æ®è§£æ ===
    function parseData(rawData) {
      if (Array.isArray(rawData)) return rawData;
      return rawData.tree || rawData.list || rawData.children || [];
    }

    function updateBadge(status, ver) {
      const el = document.getElementById('version-badge');
      let text = 'OFFLINE';
      let cls = '';

      if (status === 'NEW') { text = 'å·²æ›´æ–°'; cls = 'online'; }
      else if (status === 'LATEST') { text = 'å·²æ˜¯æœ€æ–°'; cls = 'online'; }
      else { text = 'ç¦»çº¿æ¨¡å¼'; }

      el.innerText = `${text} v${(ver || '').toString().slice(-4)}`;
      if (cls) el.classList.add(cls);
      else el.classList.remove('online');
    }

    // ====== ä¿®å¤ï¼šè¿œç«¯ data.js ä¸æ˜¯ JSONï¼Œç”¨ JS å¯¹è±¡è§£æï¼ˆé¿å… JSON.parse å´©æ‰å¯¼è‡´æ°¸è¿œç¦»çº¿ï¼‰======
    function parseRemoteLocalDataFromJs(txt) {
      // æŠ“å– const LOCAL_DATA = ...ï¼ˆå°½é‡é²æ£’ï¼‰
      const m = txt.match(/const\s+LOCAL_DATA\s*=\s*([\s\S]*?)(?:;\s*|$)/m);
      if (!m || !m[1]) return null;
      try {
        return Function('"use strict"; return (' + m[1] + ')')();
      } catch (e) {
        console.warn('remote LOCAL_DATA parse failed:', e);
        return null;
      }
    }

    // === 1. åˆå§‹åŒ– & æ›´æ–° ===
    async function init() {
      let data = null;

      // æœ¬åœ°æ•°æ®ä¼˜å…ˆå…œåº•
      if (typeof LOCAL_DATA !== 'undefined') {
        data = parseData(LOCAL_DATA);
        updateBadge('OFFLINE', LOCAL_DATA.version);
      }

      // è¿œç«¯ç‰ˆæœ¬æ£€æŸ¥
      try {
        const res = await fetch(CDN_ROOT + 'data.js?t=' + Date.now());
        if (res.ok) {
          const txt = await res.text();
          const remoteData = parseRemoteLocalDataFromJs(txt);

          if (remoteData) {
            const localVer = (typeof LOCAL_DATA !== 'undefined') ? Number(LOCAL_DATA.version || 0) : 0;
            const remoteVer = Number(remoteData.version || 0);

            if (remoteVer > localVer) {
              useOnline = true;
              data = parseData(remoteData);
              updateBadge('NEW', remoteVer);
            } else {
              useOnline = false; // ç”¨æœ¬åœ°æ›´å¿«
              updateBadge('LATEST', localVer);
            }
          }
        }
      } catch (e) {
        console.log('Keep offline');
      }

      if (data) {
        renderSidebar(data);
        renderGrid(data);
      }
    }

    // === 2. æ¸²æŸ“å¼•æ“ ===
    function renderSidebar(nodes, container = document.getElementById('tree-container'), level = 0) {
      container.innerHTML = '';
      nodes.forEach(node => {
        const isFolder = node.children && node.children.length > 0;
        const title = node.title || node.name;
        const path = node.path || node.url;

        const item = document.createElement('div');
        item.className = 'tree-node';

        const content = document.createElement('div');
        content.className = 'node-content';
        content.style.paddingLeft = `${12 + level * 16}px`;

        content.innerHTML = `
          <svg class="svg-icon" style="color:${isFolder ? '#f59e0b' : '#64748b'}; margin-right:8px;"><use href="${isFolder ? '#icon-folder' : '#icon-file'}"></use></svg>
          <span style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${title}</span>
          ${isFolder ? `<span class="arrow">â–¶</span>` : ''}
        `;

        content.onclick = () => {
          if (isFolder) {
            const arrow = content.querySelector('.arrow');
            const sub = item.querySelector('.sub-group');
            sub.classList.toggle('show');
            arrow.style.transform = sub.classList.contains('show') ? 'rotate(90deg)' : 'rotate(0deg)';
          } else {
            openFile(path, title);
            if (window.innerWidth <= 768) toggleSidebar();
          }
        };

        item.appendChild(content);

        if (isFolder) {
          const subGroup = document.createElement('div');
          subGroup.className = 'sub-group';
          item.appendChild(subGroup);
          renderSidebar(node.children, subGroup, level + 1);
        }
        container.appendChild(item);
      });
    }

    // ====== ä¿®å¤ï¼šlist-mode ä¸ç”Ÿæ•ˆçš„æ ¹å› æ˜¯ switchView å†™æ­»äº† grid displayï¼›
    // è¿™é‡Œ renderGrid å…ˆè®¾ç½® classï¼Œå†åˆ‡æ¢è§†å›¾ï¼Œä¸” switchView ä¸å†å†™æ­» grid-view display ======
    function renderGrid(nodes) {
      const grid = document.getElementById('grid-view');
      grid.innerHTML = '';
      currentMode = 'grid';

      const isRoot = historyStack.length === 0;
      document.getElementById('page-title').innerText = isRoot ? 'çŸ¥è¯†åº“é¦–é¡µ' : 'æ–‡ä»¶å¤¹';
      document.getElementById('back-btn').style.display = isRoot ? 'none' : 'flex';

      if (!isRoot) grid.classList.add('list-mode');
      else grid.classList.remove('list-mode');

      switchView('grid-view');

      nodes.forEach(node => {
        const isFolder = node.children && node.children.length > 0;
        const title = node.title || node.name;
        const path = node.path || node.url;
        const style = getTypeStyle(path, isFolder);

        const card = document.createElement('div');
        card.className = 'card';
        card.onclick = () => {
          if (isFolder) {
            enterFolder(nodes, node.children);
          } else {
            openFile(path, title);
          }
        };

        const meta = isFolder ? `${node.children.length} é¡¹` : (path ? path.split('.').pop().toUpperCase() : 'FILE');

        card.innerHTML = `
          <div class="card-icon-box" style="background:${style.bg}; color:${style.color}">
            <svg class="svg-icon" style="width:50%; height:50%"><use href="${style.icon}"></use></svg>
          </div>
          <div class="card-title">${title}</div>
          <div class="card-meta">${meta}</div>
        `;
        grid.appendChild(card);
      });
    }

    // === 3. å¯¼èˆªæ ¸å¿ƒ (è§£å†³åé€€ç›´æ¥é€€å‡ºAppçš„é—®é¢˜) ===
    function enterFolder(parentNodes, childrenNodes) {
      history.pushState({ mode: 'folder', depth: historyStack.length + 1 }, null, '#folder');
      historyStack.push(parentNodes);
      renderGrid(childrenNodes);
    }

    function openFile(path, title) {
      if (!path) return;
      const fullPath = useOnline ? (CDN_ROOT + path) : path;
      const url = encodeURI(fullPath);

      history.pushState({ mode: 'reader', file: title }, null, '#reader');

      document.getElementById('page-title').innerText = title;
      document.getElementById('back-btn').style.display = 'flex';

      if ((path || '').toLowerCase().endsWith('.pdf')) renderPdf(url);
      else renderHtml(url);
    }

    // ğŸŸ¢ ç›‘å¬ç³»ç»Ÿä¾§æ»‘/ç‰©ç†è¿”å›é”®
    window.addEventListener('popstate', () => {
      if (currentMode !== 'grid') {
        closeReader(true);
      } else if (historyStack.length > 0) {
        const parent = historyStack.pop();
        renderGrid(parent);
      }
    });

    function renderHtml(url) {
      currentMode = 'html';
      switchView('html-view');
      document.getElementById('doc-iframe').src = url;
    }

    // ====== PDF æ¸²æŸ“ï¼šæ”¯æŒä¸­æ–­æ—§æ¸²æŸ“ + é˜²é‡å¤æ‰“å¼€å†…å­˜ä¸Šæ¶¨ ======
    async function renderPdf(url) {
      currentMode = 'pdf';
      switchView('pdf-view');
      document.getElementById('reader-tools').style.display = 'flex';

      currentPdfUrl = url;

      // ä¸­æ–­æ—§æ¸²æŸ“
      pdfRenderSeq++;
      const mySeq = pdfRenderSeq;

      const container = document.getElementById('pdf-container');
      container.innerHTML = '';

      const loading = document.getElementById('loading');
      loading.style.display = 'flex';
      document.getElementById('loading-text').innerText = 'åŠ è½½ä¸­...';

      try {
        // æ¸…ç†æ—§ doc / task
        if (currentPdfDoc) {
          try { await currentPdfDoc.destroy(); } catch {}
          currentPdfDoc = null;
        }
        if (pdfLoadingTask) {
          try { await pdfLoadingTask.destroy(); } catch {}
          pdfLoadingTask = null;
        }

        pdfLoadingTask = pdfjsLib.getDocument(url);
        pdfLoadingTask.onProgress = (p) => {
          const percent = Math.round((p.loaded / p.total) * 100);
          if (!isNaN(percent)) document.getElementById('loading-text').innerText = `åŠ è½½ ${percent}%`;
        };

        const pdf = await pdfLoadingTask.promise;
        if (mySeq !== pdfRenderSeq) return; // è¢«æ–°ä»»åŠ¡æ‰“æ–­
        currentPdfDoc = pdf;

        document.getElementById('loading-text').innerText = 'æ¸²æŸ“ä¸­...';

        const scrollEl = document.getElementById('pdf-scroll');
        const clientW = scrollEl.clientWidth - 40;

        for (let i = 1; i <= pdf.numPages; i++) {
          if (mySeq !== pdfRenderSeq) return;

          const page = await pdf.getPage(i);
          const viewport = page.getViewport({ scale: currentScale });

          const canvas = document.createElement('canvas');
          canvas.className = 'pdf-page-canvas';
          const ctx = canvas.getContext('2d');

          canvas.width = viewport.width;
          canvas.height = viewport.height;

          // å®½åº¦è‡ªé€‚åº”
          const fitScale = clientW / viewport.width;
          if (fitScale < 1) {
            canvas.style.width = clientW + 'px';
            canvas.style.height = (viewport.height * fitScale) + 'px';
          }

          container.appendChild(canvas);
          await page.render({ canvasContext: ctx, viewport }).promise;

          if (i === 1) loading.style.display = 'none';
          if (i % 5 === 0) await new Promise(r => setTimeout(r, 20));
        }

        loading.style.display = 'none';
      } catch (e) {
        loading.style.display = 'none';
        alert('åŠ è½½å¤±è´¥: ' + e.message);
      }
    }

    // ====== ä¿®å¤ï¼šä¸è¦å†å†™æ­» grid-view display:gridï¼ˆå¦åˆ™ list-mode æ°¸è¿œä¸ç”Ÿæ•ˆï¼‰======
    function switchView(id) {
      const grid = document.getElementById('grid-view');
      const html = document.getElementById('html-view');
      const pdf  = document.getElementById('pdf-view');

      // hide all
      grid.style.display = 'none';
      html.style.display = 'none';
      pdf.style.display  = 'none';

      document.getElementById('reader-tools').style.display = 'none';

      if (id === 'grid-view') {
        // âœ… å…³é”®ï¼šæ¸…ç©ºè¡Œå†… displayï¼Œè®© CSS å†³å®šï¼ˆgrid æˆ– list-mode çš„ flexï¼‰
        grid.style.display = '';
      } else if (id === 'html-view') {
        html.style.display = 'flex';
      } else if (id === 'pdf-view') {
        pdf.style.display = 'flex';
      }

      const fab = document.getElementById('fab-menu');
      if (id === 'grid-view') fab.classList.add('visible');
      else fab.classList.remove('visible');
    }

    function goBack() {
      history.back();
    }

    // ====== ä¿®å¤ï¼šå…³é—­é˜…è¯»å™¨æ—¶æ¸…ç† iframe + PDF canvasï¼Œé¿å…è¶Šç”¨è¶Šå¡ ======
    function closeReader() {
      currentMode = 'grid';
      switchView('grid-view');

      // æ¸…ç† iframe
      document.getElementById('doc-iframe').src = '';

      // æ¸…ç† PDF
      document.getElementById('pdf-container').innerHTML = '';
      document.getElementById('reader-tools').style.display = 'none';

      // ä¸­æ–­ä»»åŠ¡
      pdfRenderSeq++;
      try { pdfLoadingTask && pdfLoadingTask.destroy && pdfLoadingTask.destroy(); } catch {}
      pdfLoadingTask = null;

      try { currentPdfDoc && currentPdfDoc.destroy && currentPdfDoc.destroy(); } catch {}
      currentPdfDoc = null;
      currentPdfUrl = '';

      document.getElementById('page-title').innerText = historyStack.length > 0 ? 'æ–‡ä»¶å¤¹' : 'çŸ¥è¯†åº“é¦–é¡µ';
      if (historyStack.length === 0) document.getElementById('back-btn').style.display = 'none';
    }

    // ====== ä¿®å¤ï¼šç¼©æ”¾ä¸å†ç”¨ transform æ‹‰ä¼¸ï¼ˆç³Š+å¸ƒå±€æ€ªï¼‰ï¼Œæ”¹ä¸º debounce é‡æ¸²æŸ“ ======
    window.zoomPdf = function(delta) {
      currentScale += delta;
      if (currentScale < 0.5) currentScale = 0.5;

      document.getElementById('zoom-val').innerText = Math.round(currentScale * 100);

      if (currentMode !== 'pdf' || !currentPdfUrl) return;

      clearTimeout(zoomTimer);
      zoomTimer = setTimeout(() => {
        renderPdf(currentPdfUrl);
      }, 120);
    }

    window.toggleSidebar = function() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('overlay');
      sidebar.classList.toggle('open');
      overlay.classList.toggle('show');
    }

    init();
  </script>
</body>
</html>



æœªé€‰æ‹©æ–‡ä»¶æœªé€‰æ‹©æ–‡ä»¶
ChatGPT ä¹Ÿå¯èƒ½ä¼šçŠ¯é”™ã€‚è¯·æ ¸æŸ¥é‡è¦ä¿¡æ¯ã€‚æŸ¥çœ‹ Cookie é¦–é€‰é¡¹ã€‚
