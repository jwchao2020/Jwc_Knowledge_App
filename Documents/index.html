<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Jwc çŸ¥è¯†åº“ (Pro)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>

    <style>
        /* === åŸºç¡€è®¾ç½® === */
        :root { --primary: #007bff; --bg: #f8f9fa; --text: #333; --card: #fff; }
        [data-theme="dark"] { --primary: #4dabf7; --bg: #121212; --text: #e0e0e0; --card: #1e1e1e; }
        
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; transition: 0.3s; }
        
        /* === é¡¶éƒ¨å¯¼èˆªæ  === */
        header { 
            background: var(--card); padding: 12px 20px; 
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            position: sticky; top: 0; z-index: 50;
        }
        .app-title { font-weight: 700; font-size: 18px; }
        .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #ccc; margin-left: 5px; }
        .status-dot.online { background: #28a745; box-shadow: 0 0 5px #28a745; }

        /* === ç›®å½•åˆ—è¡¨ === */
        #file-list { padding-bottom: 80px; }
        .node { background: var(--card); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .node-title { padding: 16px 20px; display: flex; align-items: center; cursor: pointer; }
        .node-title:active { background: rgba(0,0,0,0.03); }
        .icon { margin-right: 12px; font-size: 20px; }
        .text { flex: 1; font-size: 16px; font-weight: 500; }
        .children { display: none; padding-left: 20px; background: rgba(0,0,0,0.02); }
        .children.show { display: block; }

        /* === ğŸ“– Pro é˜…è¯»å™¨å®¹å™¨ === */
        #pdf-viewer {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 100; flex-direction: column;
        }

        /* é˜…è¯»å™¨é¡¶éƒ¨å·¥å…·æ  */
        .viewer-header {
            background: var(--card); padding: 10px 15px; 
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 101;
        }
        .viewer-title { font-size: 14px; max-width: 60%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .btn-group { display: flex; gap: 15px; }
        .icon-btn { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text); padding: 5px; }

        /* é˜…è¯»åŒºåŸŸ */
        #pdf-content {
            flex: 1; overflow-y: auto; overflow-x: hidden;
            -webkit-overflow-scrolling: touch; padding: 10px 0;
            position: relative;
        }

        /* âœ¨ çŸ¢é‡é¡µé¢æ ·å¼ (å…³é”®) */
        .pdf-page {
            position: relative; margin: 0 auto 10px auto;
            background: white; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            /* ç¡®ä¿é¡µé¢å±…ä¸­ä¸”ä¸è¶…è¿‡å±å¹•å®½åº¦ */
            width: 100%; max-width: 800px; 
        }
        /* SVG å¿…é¡»æ’‘æ»¡å®¹å™¨ */
        .pdf-page svg { width: 100%; height: auto; display: block; }

        /* åº•éƒ¨æµ®åŠ¨æ  (é¡µç ) */
        .page-indicator {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); color: white; padding: 5px 15px; 
            border-radius: 20px; font-size: 12px; pointer-events: none;
            opacity: 0; transition: opacity 0.3s;
        }
        #pdf-viewer:hover .page-indicator { opacity: 1; } /* è§¦æ‘¸æ—¶æ˜¾ç¤º */

        /* åŠ è½½åŠ¨ç”» */
        .loading-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 99;
        }
        .spinner {
            width: 40px; height: 40px; border: 3px solid #eee; 
            border-top: 3px solid var(--primary); border-radius: 50%; 
            animation: spin 1s infinite linear; margin-bottom: 15px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<header>
    <div class="app-title">ğŸ“š çŸ¥è¯†åº“ <span id="status-dot" class="status-dot"></span></div>
    <button class="icon-btn" onclick="toggleTheme()">ğŸŒ™</button>
</header>
<div id="file-list"></div>

<div id="pdf-viewer">
    <div class="viewer-header">
        <button class="icon-btn" onclick="closePdf()">âœ•</button>
        <span class="viewer-title" id="doc-title">æ–‡æ¡£æ ‡é¢˜</span>
        <button class="icon-btn" onclick="toggleTheme()">ğŸŒ™</button>
    </div>
    
    <div id="pdf-content" onscroll="updatePageNum()">
        </div>
    
    <div class="page-indicator" id="page-num">1 / ?</div>

    <div id="loading-box" class="loading-overlay" style="display:none">
        <div class="spinner"></div>
        <div id="loading-text">æ­£åœ¨æ¸²æŸ“çŸ¢é‡å›¾...</div>
    </div>
</div>

<script src="data.js"></script>
<script>
    // === âš™ï¸ é…ç½®åŒºåŸŸ ===
    const USER = 'jwchao2020';
    const REPO = 'Jwc_Knowledge_App';
    const BRANCH = 'main'; 
    const CDN_ROOT = `https://cdn.jsdelivr.net/gh/${USER}/${REPO}@${BRANCH}/Documents/`;
    const DATA_URL = CDN_ROOT + 'data.js';

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';

    // DOM å…ƒç´ 
    const fileListEl = document.getElementById('file-list');
    const viewerEl = document.getElementById('pdf-viewer');
    const contentEl = document.getElementById('pdf-content');
    const titleEl = document.getElementById('doc-title');
    const loadingBox = document.getElementById('loading-box');
    const loadingText = document.getElementById('loading-text');
    const pageNumEl = document.getElementById('page-num');
    const statusDot = document.getElementById('status-dot');
    
    let useOnline = false;
    let pagePositions = []; // å­˜å‚¨æ¯é¡µçš„é«˜åº¦ä½ç½®ï¼Œç”¨äºè®¡ç®—å½“å‰é¡µç 

    // === ğŸš€ æ ¸å¿ƒï¼šSVG çŸ¢é‡æ¸²æŸ“å¼•æ“ ===
    async function openPdf(relativePath, title) {
        if (!useOnline) {
            alert("âš ï¸ çŸ¢é‡æ¨¡å¼éœ€è¦åœ¨çº¿åŠ è½½ï¼Œè¯·è¿æ¥ç½‘ç»œã€‚");
            return;
        }

        viewerEl.style.display = 'flex';
        titleEl.innerText = title;
        contentEl.innerHTML = ''; 
        loadingBox.style.display = 'flex';
        loadingText.innerText = "æ­£åœ¨ä¸‹è½½æ–‡æ¡£...";
        pagePositions = [];

        try {
            const url = CDN_ROOT + relativePath;
            const loadingTask = pdfjsLib.getDocument(url);
            
            // ä¸‹è½½è¿›åº¦
            loadingTask.onProgress = (p) => {
                const percent = Math.round((p.loaded / p.total) * 100);
                if(!isNaN(percent)) loadingText.innerText = `ä¸‹è½½ä¸­... ${percent}%`;
            };

            const pdf = await loadingTask.promise;
            loadingText.innerText = "æ­£åœ¨è§£æçŸ¢é‡è·¯å¾„...";
            pageNumEl.innerText = `1 / ${pdf.numPages}`;

            // âš¡ï¸ åˆ†æ‰¹æ¸²æŸ“ç­–ç•¥ï¼šå…ˆæ¸²æŸ“å‰2é¡µï¼Œè®©ç”¨æˆ·é©¬ä¸Šèƒ½çœ‹ï¼Œå‰©ä¸‹çš„åå°æ…¢æ…¢åŠ è½½
            for (let i = 1; i <= pdf.numPages; i++) {
                await renderPageAsSVG(pdf, i);
                // è®°å½•æ¯é¡µå¤§æ¦‚çš„é«˜åº¦ç”¨äºé¡µç è®¡ç®—
                pagePositions.push(contentEl.scrollHeight); 
                // å‰3é¡µä¸ç­‰å¾…ï¼Œåé¢æ¯é¡µç¨å¾®ç¼“å†²ä¸€ä¸‹é˜²æ­¢å¡é¡¿
                if (i > 3) await new Promise(r => setTimeout(r, 100));
            }
            loadingBox.style.display = 'none';

        } catch (error) {
            console.error(error);
            loadingText.innerHTML = `<span style="color:#e74c3c">åŠ è½½å¤±è´¥<br>${error.message}</span>`;
        }
    }

    // âœ¨ å°†å•é¡µæ¸²æŸ“ä¸º SVG (æ— é™æ¸…æ™°çš„å…³é”®)
    async function renderPageAsSVG(pdf, num) {
        const page = await pdf.getPage(num);
        const viewport = page.getViewport({ scale: 1.0 }); // çŸ¢é‡å›¾ä¸éœ€è¦ç¼©æ”¾å€ç‡ï¼Œæœ¬èº«å°±æ˜¯æ— é™ç²¾åº¦çš„

        // åˆ›å»ºå®¹å™¨
        const pageDiv = document.createElement('div');
        pageDiv.className = 'pdf-page';
        // è®¾ç½®å®¹å™¨æ¯”ä¾‹ï¼Œé˜²æ­¢æŠ–åŠ¨
        pageDiv.style.width = '100%';
        pageDiv.style.aspectRatio = `${viewport.width} / ${viewport.height}`;
        contentEl.appendChild(pageDiv);

        // SVG æ¸²æŸ“å™¨
        const opList = await page.getOperatorList();
        const svgGfx = new pdfjsLib.SVGGraphics(page.commonObjs, page.objs);
        const svg = await svgGfx.getSVG(opList, viewport);
        
        // å¡«å…¥ DOM
        pageDiv.appendChild(svg);
    }

    // === è¾…åŠ©åŠŸèƒ½ ===
    function closePdf() {
        viewerEl.style.display = 'none';
        contentEl.innerHTML = ''; // é‡Šæ”¾å†…å­˜
    }

    // æ»šåŠ¨æ—¶æ›´æ–°é¡µç 
    function updatePageNum() {
        const scrollTop = contentEl.scrollTop;
        const pageHeight = contentEl.scrollHeight / pagePositions.length; // ä¼°ç®—å¹³å‡é«˜åº¦
        const currentPage = Math.min(pagePositions.length, Math.max(1, Math.ceil((scrollTop + window.innerHeight/3) / pageHeight)));
        pageNumEl.innerText = `${currentPage} / ${pagePositions.length}`;
        pageNumEl.style.opacity = '1';
        clearTimeout(window.hidePageTimer);
        window.hidePageTimer = setTimeout(() => pageNumEl.style.opacity = '0', 2000);
    }

    // å¤œé—´æ¨¡å¼åˆ‡æ¢
    function toggleTheme() {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
        // PDF å†…å®¹åè‰² (ç®€å•çš„å¤œé—´æ¨¡å¼å®ç°)
        contentEl.style.filter = isDark ? 'none' : 'invert(0.9) hue-rotate(180deg)';
    }

    // === ç›®å½•æ¸²æŸ“ ===
    function renderTree(nodes, container) {
        nodes.forEach(node => {
            const div = document.createElement('div');
            div.className = 'node';
            if (node.pdf) {
                div.innerHTML = `<div class="node-title" onclick="openPdf('${node.pdf}', '${node.title}')"><span class="icon">ğŸ“„</span><span class="text">${node.title}</span></div>`;
            } else {
                const id = 'g-' + Math.random().toString(36).substr(2,9);
                div.innerHTML = `
                    <div class="node-title" onclick="toggle('${id}', this)">
                        <span class="icon">ğŸ“‚</span><span class="text">${node.title}</span>
                    </div>
                    <div class="children" id="${id}"></div>`;
                container.appendChild(div);
                if (node.children) renderTree(node.children, div.querySelector('.children'));
                return; // æ–‡ä»¶å¤¹ä¸éœ€è¦appendåˆ°å¤–é¢
            }
            container.appendChild(div);
        });
    }
    window.toggle = (id, el) => {
        const child = document.getElementById(id);
        child.classList.toggle('show');
        el.style.backgroundColor = child.classList.contains('show') ? 'rgba(0,0,0,0.03)' : '';
    };

    // === åˆå§‹åŒ– ===
    async function init() {
        // åŠ è½½æœ¬åœ°å…œåº•
        if (typeof LOCAL_DATA !== 'undefined') renderTree(LOCAL_DATA.tree, fileListEl);
        
        // å°è¯•è”ç½‘
        try {
            const res = await fetch(DATA_URL);
            if(res.ok) {
                const txt = await res.text();
                const json = JSON.parse(txt.substring(txt.indexOf('{'), txt.lastIndexOf('}')+1));
                
                // ç‰ˆæœ¬æ£€æµ‹
                const localVer = (typeof LOCAL_DATA !== 'undefined') ? Number(LOCAL_DATA.version) : 0;
                if (Number(json.version) >= localVer) {
                    useOnline = true;
                    statusDot.classList.add('online');
                    fileListEl.innerHTML = ''; // æ¸…ç©ºæœ¬åœ°æ—§åˆ—è¡¨
                    renderTree(json.tree, fileListEl);
                }
            }
        } catch(e) { console.log('Offline mode'); }
    }

    init();
</script>
</body>
</html>