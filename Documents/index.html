<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Jwc çŸ¥è¯†åº“</title>
    
    <script src="lib/pdfjs/pdf.min.js"></script>

    <style>
        :root { --primary: #007bff; --bg: #f8f9fa; --text: #333; --card: #fff; --line: #eee; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; overflow: hidden; }

        /* === åˆ—è¡¨é¡µ === */
        #home-view { height: 100vh; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        
        header { 
            background: var(--primary); color: white; padding: 15px; 
            position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .app-title { font-weight: bold; font-size: 18px; }
        .version-tag { font-size: 12px; opacity: 0.8; background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 4px; }

        .node { background: var(--card); border-bottom: 1px solid var(--line); }
        .node-title { padding: 16px; display: flex; align-items: center; cursor: pointer; transition: background 0.2s; }
        .node-title:active { background: #f0f0f0; }
        .icon { margin-right: 12px; font-size: 20px; }
        .text { flex: 1; font-size: 16px; font-weight: 500; }
        .arrow { color: #999; font-size: 12px; transition: transform 0.3s; }
        .children { display: none; padding-left: 20px; background: #f9f9f9; border-top: 1px solid var(--line); }
        .children.show { display: block; }
        .arrow.rotate { transform: rotate(90deg); }

        /* === é˜…è¯»å™¨é€šç”¨ === */
        .viewer-container {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 200; flex-direction: column; background: white;
        }

        .reader-bar {
            background: #333; color: white; padding: 10px 15px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3); z-index: 201; flex-shrink: 0;
        }
        .reader-title { font-size: 14px; max-width: 50%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .btn { background: #555; border: none; color: white; padding: 6px 12px; border-radius: 4px; font-size: 14px; }
        
        /* HTML iframe */
        .iframe-box { flex: 1; width: 100%; border: none; background: white; }

        /* PDF View */
        #pdf-view { background: #525659; }
        #pdf-scroll-container { flex: 1; overflow: auto; padding: 20px; position: relative; touch-action: pan-x pan-y; }
        .pdf-page { margin: 0 auto 15px auto; background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.3); width: 100%; }
        .loading-box { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); color: white; text-align: center; }

        /* é”™è¯¯å¼¹çª— */
        #error-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 999; padding: 20px; box-sizing: border-box;
            color: #ff6b6b; font-family: monospace; white-space: pre-wrap; word-break: break-all; overflow: auto;
        }
    </style>
</head>
<body>

    <div id="home-view">
        <header>
            <div class="app-title">ğŸ“š çŸ¥è¯†åº“</div>
            <div id="version-display" class="version-tag">Loading...</div>
        </header>
        <div id="file-list"></div>
    </div>

    <div id="iframe-view" class="viewer-container">
        <div class="reader-bar">
            <button class="btn" onclick="closeReader()">â® è¿”å›</button>
            <span class="reader-title" id="iframe-title">æ–‡æ¡£</span>
            <div style="width:40px"></div>
        </div>
        <iframe id="content-iframe" class="iframe-box" src=""></iframe>
    </div>

    <div id="pdf-view" class="viewer-container">
        <div class="reader-bar">
            <button class="btn" onclick="closeReader()">â® è¿”å›</button>
            <span class="reader-title" id="pdf-title">PDF</span>
            <div>
                <button class="btn" onclick="changeZoom(-0.2)">ï¼</button>
                <button class="btn" onclick="changeZoom(0.2)">ï¼‹</button>
            </div>
        </div>
        <div id="pdf-scroll-container">
            <div id="pdf-content-wrapper"></div>
        </div>
        <div id="loading-box" class="loading-box" style="display:none">
            <div style="font-size:24px; margin-bottom:10px;">â³</div>
            <div id="loading-text">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <div id="error-modal"></div>

    <script src="data.js"></script>

<script>
    // === 1. åˆå§‹åŒ– PDF Worker (å…³é”®è·¯å¾„ä¿®æ­£) ===
    if (typeof pdfjsLib !== 'undefined') {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'lib/pdfjs/pdf.worker.min.js';
    } else {
        showError("ä¸¥é‡é”™è¯¯: pdfjsLib æœªåŠ è½½ã€‚\nè¯·æ£€æŸ¥ lib/pdfjs/pdf.min.js æ˜¯å¦å­˜åœ¨ä¸”å¤§å°æ­£å¸¸ã€‚");
    }

    // === 2. æ ¸å¿ƒé€»è¾‘ ===
    const homeView = document.getElementById('home-view');
    const iframeView = document.getElementById('iframe-view');
    const pdfView = document.getElementById('pdf-view');
    const fileListEl = document.getElementById('file-list');
    let lastScrollY = 0;
    let currentScale = 1.0;

    // æ™ºèƒ½è·å–æ•°æ®èŠ‚ç‚¹ (è§£å†³ undefined length é—®é¢˜)
    function getRootNodes() {
        if (typeof LOCAL_DATA === 'undefined') {
            showError("LOCAL_DATA æœªå®šä¹‰ã€‚\nè¯·æ£€æŸ¥ data.js æ˜¯å¦ç”ŸæˆæˆåŠŸã€‚");
            return null;
        }

        // å°è¯•æ˜¾ç¤ºç‰ˆæœ¬å·
        if (LOCAL_DATA.version) {
            document.getElementById('version-display').innerText = "v" + LOCAL_DATA.version;
        }

        // ğŸ” è‡ªåŠ¨å¯»æ‰¾æ•°ç»„ï¼šä¸ç®¡æ˜¯ tree, children, items è¿˜æ˜¯ root æœ¬èº«
        if (Array.isArray(LOCAL_DATA.tree)) return LOCAL_DATA.tree;
        if (Array.isArray(LOCAL_DATA.children)) return LOCAL_DATA.children;
        if (Array.isArray(LOCAL_DATA.items)) return LOCAL_DATA.items;
        if (Array.isArray(LOCAL_DATA)) return LOCAL_DATA; // æ ¹èŠ‚ç‚¹å°±æ˜¯æ•°ç»„

        // å¦‚æœè¿˜æ²¡æ‰¾åˆ°ï¼Œéå†å±æ€§æ‰¾ç¬¬ä¸€ä¸ªæ•°ç»„
        for (let key in LOCAL_DATA) {
            if (Array.isArray(LOCAL_DATA[key])) {
                console.log(`è‡ªåŠ¨å‘ç°æ•°æ®èŠ‚ç‚¹: ${key}`);
                return LOCAL_DATA[key];
            }
        }

        showError("æ— æ³•è¯†åˆ«æ•°æ®ç»“æ„ã€‚\nLOCAL_DATA ä¸­æ‰¾ä¸åˆ°æ•°ç»„ã€‚\nå¯ç”¨å±æ€§: " + Object.keys(LOCAL_DATA).join(', '));
        return null;
    }

    // æ¸²æŸ“ç›®å½•æ ‘
    function renderTree(nodes, container) {
        if (!nodes) return;
        nodes.forEach(node => {
            const title = node.title || node.name || "æœªå‘½å";
            // å…¼å®¹å¤šç§è·¯å¾„å­—æ®µ
            const path = node.url || node.path || node.pdf || node.link; 
            const isFolder = !path && (node.children || node.items);

            const div = document.createElement('div');
            div.className = 'node';

            if (isFolder) {
                // æ–‡ä»¶å¤¹
                const uid = 'folder-' + Math.random().toString(36).substr(2, 9);
                div.innerHTML = `
                    <div class="node-title" onclick="toggleFolder('${uid}', this)">
                        <span class="icon">ğŸ“‚</span>
                        <span class="text">${title}</span>
                        <span class="arrow">â–¶</span>
                    </div>
                    <div class="children" id="${uid}"></div>
                `;
                container.appendChild(div);
                // é€’å½’æ¸²æŸ“å­èŠ‚ç‚¹ (æ³¨æ„å­—æ®µåå…¼å®¹)
                renderTree(node.children || node.items, div.querySelector('.children'));
            } else {
                // æ–‡ä»¶
                const isPdf = path && path.toLowerCase().endsWith('.pdf');
                const icon = isPdf ? 'ğŸ“„' : 'ğŸŒ';
                // è¿™é‡Œçš„ path éœ€è¦å¤„ç†ä¸€ä¸‹ï¼Œå¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„
                div.innerHTML = `
                    <div class="node-title" onclick="openFile('${path}', '${title}', ${isPdf})">
                        <span class="icon">${icon}</span>
                        <span class="text">${title}</span>
                    </div>
                `;
                container.appendChild(div);
            }
        });
    }

    // åˆ‡æ¢æ–‡ä»¶å¤¹
    window.toggleFolder = function(id, headerEl) {
        const content = document.getElementById(id);
        const arrow = headerEl.querySelector('.arrow');
        const isClosed = content.style.display !== 'block'; // ç®€å•çš„åˆ¤æ–­
        
        if (content.classList.contains('show')) {
            content.classList.remove('show');
            arrow.classList.remove('rotate');
        } else {
            content.classList.add('show');
            arrow.classList.add('rotate');
        }
    };

    // æ‰“å¼€æ–‡ä»¶åˆ†å‘
    window.openFile = function(path, title, isPdf) {
        if (!path) return alert("è·¯å¾„ä¸ºç©º");
        
        lastScrollY = homeView.scrollTop;
        homeView.style.display = 'none';
        
        // æ¨é€å†å²è®°å½•ï¼Œå¤„ç†å®‰å“è¿”å›é”®
        history.pushState({view: 'reader'}, null, '#reader');

        if (isPdf) {
            openPdfViewer(path, title);
        } else {
            openHtmlViewer(path, title);
        }
    };

    // === HTML é˜…è¯»å™¨é€»è¾‘ ===
    function openHtmlViewer(path, title) {
        iframeView.style.display = 'flex';
        document.getElementById('iframe-title').innerText = title;
        document.getElementById('content-iframe').src = path;
    }

    // === PDF é˜…è¯»å™¨é€»è¾‘ ===
    async function openPdfViewer(path, title) {
        pdfView.style.display = 'flex';
        document.getElementById('pdf-title').innerText = title;
        document.getElementById('pdf-content-wrapper').innerHTML = ''; // æ¸…ç©º
        document.getElementById('loading-box').style.display = 'block';
        currentScale = 1.0;
        updatePdfZoom();

        try {
            const loadingTask = pdfjsLib.getDocument(path);
            loadingTask.onProgress = (p) => {
                const percent = Math.round((p.loaded / p.total) * 100);
                if (!isNaN(percent)) document.getElementById('loading-text').innerText = `åŠ è½½ ${percent}%`;
            };

            const pdf = await loadingTask.promise;
            
            // é€é¡µæ¸²æŸ“
            for (let i = 1; i <= pdf.numPages; i++) {
                await renderPdfPage(pdf, i);
                // æ¯æ¸²æŸ“5é¡µæ­‡ä¸€ä¸‹ï¼Œé˜²æ­¢æ‰‹æœºå¡æ­»
                if (i % 3 === 0) await new Promise(r => setTimeout(r, 50));
            }
            document.getElementById('loading-box').style.display = 'none';
        } catch (err) {
            console.error(err);
            alert("PDF åŠ è½½å¤±è´¥: " + err.message);
            closeReader();
        }
    }

    async function renderPdfPage(pdf, num) {
        const page = await pdf.getPage(num);
        const viewport = page.getViewport({ scale: 1.0 }); // åŸºç¡€å€ç‡
        
        const div = document.createElement('div');
        div.className = 'pdf-page';
        // è®¡ç®—å®½é«˜æ¯”ï¼Œé˜²æ­¢å¸ƒå±€æŠ–åŠ¨
        div.style.aspectRatio = `${viewport.width} / ${viewport.height}`;
        document.getElementById('pdf-content-wrapper').appendChild(div);

        // ä½¿ç”¨ SVG æ¸²æŸ“ (æ›´æ¸…æ™°)
        const opList = await page.getOperatorList();
        const svgGfx = new pdfjsLib.SVGGraphics(page.commonObjs, page.objs);
        const svg = await svgGfx.getSVG(opList, viewport);
        svg.style.width = "100%";
        svg.style.height = "100%";
        div.appendChild(svg);
    }

    // === ç¼©æ”¾æ§åˆ¶ ===
    window.changeZoom = function(delta) {
        currentScale += delta;
        if (currentScale < 0.5) currentScale = 0.5;
        if (currentScale > 3.0) currentScale = 3.0;
        updatePdfZoom();
    };

    function updatePdfZoom() {
        const wrapper = document.getElementById('pdf-content-wrapper');
        wrapper.style.width = `${currentScale * 100}%`;
        wrapper.style.margin = currentScale <= 1.0 ? "0 auto" : "0";
    }

    // === å…³é—­ / è¿”å› ===
    window.closeReader = function(isHardwareBack = false) {
        if (!isHardwareBack) history.back();
        
        iframeView.style.display = 'none';
        pdfView.style.display = 'none';
        homeView.style.display = 'block';
        
        // æ¸…ç†èµ„æº
        document.getElementById('content-iframe').src = '';
        document.getElementById('pdf-content-wrapper').innerHTML = '';
        
        homeView.scrollTop = lastScrollY;
    };

    // ç›‘å¬å®‰å“ç‰©ç†è¿”å›é”®
    window.addEventListener('popstate', () => {
        if (iframeView.style.display === 'flex' || pdfView.style.display === 'flex') {
            closeReader(true); // ä¼ å…¥ true è¡¨ç¤ºä¸éœ€è¦å† history.back()
        }
    });

    // === å¯åŠ¨ ===
    function init() {
        try {
            const data = getRootNodes();
            if (data) {
                renderTree(data, fileListEl);
            }
        } catch (e) {
            showError("åˆå§‹åŒ–å¤±è´¥: " + e.message);
        }
    }

    function showError(msg) {
        const el = document.getElementById('error-modal');
        el.style.display = 'block';
        el.innerText += "\n================\n" + msg;
    }

    // å¼€å§‹è¿è¡Œ
    init();

</script>
</body>
</html>