<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Jwc çŸ¥è¯†åº“</title>
    
    <script src="lib/pdfjs/pdf.min.js"></script>

    <style>
        :root { --primary: #007bff; --bg: #f8f9fa; --text: #333; --card: #fff; --line: #eee; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; overflow: hidden; }

        /* === åˆ—è¡¨é¡µ === */
        #home-view { height: 100vh; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        
        header { 
            background: var(--primary); color: white; padding: 15px; 
            position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .app-title { font-weight: bold; font-size: 18px; }
        .version-tag { font-size: 12px; opacity: 0.8; background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 4px; }

        .node { background: var(--card); border-bottom: 1px solid var(--line); }
        .node-title { padding: 16px; display: flex; align-items: center; cursor: pointer; transition: background 0.2s; }
        .node-title:active { background: #f0f0f0; }
        .icon { margin-right: 12px; font-size: 20px; }
        .text { flex: 1; font-size: 16px; font-weight: 500; }
        .arrow { color: #999; font-size: 12px; transition: transform 0.3s; }
        .children { display: none; padding-left: 20px; background: #f9f9f9; border-top: 1px solid var(--line); }
        .children.show { display: block; }
        .arrow.rotate { transform: rotate(90deg); }

        /* === é˜…è¯»å™¨é€šç”¨ === */
        .viewer-container {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 200; flex-direction: column; background: white;
        }

        .reader-bar {
            background: #333; color: white; padding: 10px 15px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3); z-index: 201; flex-shrink: 0;
        }
        .reader-title { font-size: 14px; max-width: 50%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .btn { background: #555; border: none; color: white; padding: 6px 12px; border-radius: 4px; font-size: 14px; }
        
        /* HTML iframe */
        .iframe-box { flex: 1; width: 100%; border: none; background: white; }

        /* PDF View */
        #pdf-view { background: #525659; }
        #pdf-scroll-container { flex: 1; overflow: auto; padding: 20px; position: relative; touch-action: pan-x pan-y; }
        .pdf-page { margin: 0 auto 15px auto; background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.3); width: 100%; }
        .loading-box { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); color: white; text-align: center; }

        /* é”™è¯¯å¼¹çª— */
        #error-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 999; padding: 20px; box-sizing: border-box;
            color: #ff6b6b; font-family: monospace; white-space: pre-wrap; word-break: break-all; overflow: auto;
        }
    </style>
</head>
<body>

    <div id="home-view">
        <header>
            <div class="app-title">ğŸ“š çŸ¥è¯†åº“</div>
            <div id="version-display" class="version-tag">Loading...</div>
        </header>
        <div id="file-list"></div>
    </div>

    <div id="iframe-view" class="viewer-container">
        <div class="reader-bar">
            <button class="btn" onclick="closeReader()">â® è¿”å›</button>
            <span class="reader-title" id="iframe-title">æ–‡æ¡£</span>
            <div style="width:40px"></div>
        </div>
        <iframe id="content-iframe" class="iframe-box" src=""></iframe>
    </div>

    <div id="pdf-view" class="viewer-container">
        <div class="reader-bar">
            <button class="btn" onclick="closeReader()">â® è¿”å›</button>
            <span class="reader-title" id="pdf-title">PDF</span>
            <div>
                <button class="btn" onclick="changeZoom(-0.2)">ï¼</button>
                <button class="btn" onclick="changeZoom(0.2)">ï¼‹</button>
            </div>
        </div>
        <div id="pdf-scroll-container">
            <div id="pdf-content-wrapper"></div>
        </div>
        <div id="loading-box" class="loading-box" style="display:none">
            <div style="font-size:24px; margin-bottom:10px;">â³</div>
            <div id="loading-text">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <div id="error-modal"></div>

    <script src="data.js"></script>

<script>
    // === 0. â˜ï¸ åœ¨çº¿æ›´æ–°é…ç½® (è¯·ä¿®æ”¹ä¸ºä½ çš„ä»“åº“ä¿¡æ¯) ===
    const USER = 'jwchao2020';
    const REPO = 'Jwc_Knowledge_App';
    const BRANCH = 'gh-pages'; // å¿…é¡»æ˜¯ gh-pages åˆ†æ”¯
    const CDN_ROOT = `https://cdn.jsdelivr.net/gh/${USER}/${REPO}@${BRANCH}/Documents/`;

    let useOnline = false; // æ ‡è®°å½“å‰æ˜¯å¦ä½¿ç”¨åœ¨çº¿æ•°æ®

    // === 1. åˆå§‹åŒ– PDF Worker ===
    if (typeof pdfjsLib !== 'undefined') {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'lib/pdfjs/pdf.worker.min.js';
    } else {
        showError("ä¸¥é‡é”™è¯¯: pdfjsLib æœªåŠ è½½ã€‚\nè¯·æ£€æŸ¥ lib/pdfjs/pdf.min.js æ˜¯å¦å­˜åœ¨ã€‚");
    }

    // === 2. æ ¸å¿ƒé€»è¾‘ ===
    const homeView = document.getElementById('home-view');
    const iframeView = document.getElementById('iframe-view');
    const pdfView = document.getElementById('pdf-view');
    const fileListEl = document.getElementById('file-list');
    let lastScrollY = 0;
    let currentScale = 1.0;

    // æ™ºèƒ½è·å–æ•°æ®èŠ‚ç‚¹
    function getRootNodes(dataObj) {
        if (!dataObj) return null;
        if (dataObj.version) {
            const verText = useOnline ? `ğŸŸ¢ åœ¨çº¿ v${dataObj.version}` : `âšª ç¦»çº¿ v${dataObj.version}`;
            document.getElementById('version-display').innerText = verText;
        }

        if (Array.isArray(dataObj.tree)) return dataObj.tree;
        if (Array.isArray(dataObj.list)) return dataObj.list; // å…¼å®¹ä¸åŒè„šæœ¬ç”Ÿæˆçš„å­—æ®µ
        if (Array.isArray(dataObj)) return dataObj;
        return null;
    }

    // æ¸²æŸ“ç›®å½•æ ‘
    function renderTree(nodes, container) {
        container.innerHTML = ''; // æ¸…ç©ºæ—§æ•°æ®
        if (!nodes) return;
        
        nodes.forEach(node => {
            const title = node.title || node.name || "æœªå‘½å";
            const path = node.path || node.url || node.link; 
            const isFolder = !path && (node.children || node.items);

            const div = document.createElement('div');
            div.className = 'node';

            if (isFolder) {
                const uid = 'folder-' + Math.random().toString(36).substr(2, 9);
                div.innerHTML = `
                    <div class="node-title" onclick="toggleFolder('${uid}', this)">
                        <span class="icon">ğŸ“‚</span>
                        <span class="text">${title}</span>
                        <span class="arrow">â–¶</span>
                    </div>
                    <div class="children" id="${uid}"></div>
                `;
                container.appendChild(div);
                renderTree(node.children || node.items, div.querySelector('.children'));
            } else {
                const isPdf = path && path.toLowerCase().endsWith('.pdf');
                const icon = isPdf ? 'ğŸ“„' : 'ğŸŒ';
                // ğŸŸ¢ å…³é”®ä¿®æ”¹ï¼šä¼ å…¥ç›¸å¯¹è·¯å¾„ï¼ŒopenFile ä¼šè´Ÿè´£æ‹¼æ¥ CDN å‰ç¼€
                div.innerHTML = `
                    <div class="node-title" onclick="openFile('${path}', '${title}', ${isPdf})">
                        <span class="icon">${icon}</span>
                        <span class="text">${title}</span>
                    </div>
                `;
                container.appendChild(div);
            }
        });
    }

    window.toggleFolder = function(id, headerEl) {
        const content = document.getElementById(id);
        const arrow = headerEl.querySelector('.arrow');
        if (content.classList.contains('show')) {
            content.classList.remove('show');
            arrow.classList.remove('rotate');
        } else {
            content.classList.add('show');
            arrow.classList.add('rotate');
        }
    };

    // ğŸŸ¢ å…³é”®ä¿®æ”¹ï¼šæ‰“å¼€æ–‡ä»¶æ—¶è‡ªåŠ¨æ‹¼æ¥åœ¨çº¿ URL
    window.openFile = function(relativePath, title, isPdf) {
        if (!relativePath) return alert("è·¯å¾„ä¸ºç©º");
        
        // å¦‚æœæ˜¯åœ¨çº¿æ¨¡å¼ï¼Œè¿™å°±æ‹¼æ¥æˆ https://cdn.../content/xxx.html
        // å¦‚æœæ˜¯ç¦»çº¿æ¨¡å¼ï¼Œè¿™å°±æ˜¯ content/xxx.html (æœ¬åœ°ç›¸å¯¹è·¯å¾„)
        const fullPath = useOnline ? (CDN_ROOT + relativePath) : relativePath;
        
        lastScrollY = homeView.scrollTop;
        homeView.style.display = 'none';
        history.pushState({view: 'reader'}, null, '#reader');

        if (isPdf) {
            openPdfViewer(fullPath, title);
        } else {
            openHtmlViewer(fullPath, title);
        }
    };

    function openHtmlViewer(path, title) {
        iframeView.style.display = 'flex';
        document.getElementById('iframe-title').innerText = title;
        document.getElementById('content-iframe').src = path;
    }

    async function openPdfViewer(path, title) {
        pdfView.style.display = 'flex';
        document.getElementById('pdf-title').innerText = title;
        document.getElementById('pdf-content-wrapper').innerHTML = '';
        document.getElementById('loading-box').style.display = 'block';
        currentScale = 1.0;
        updatePdfZoom();

        try {
            const loadingTask = pdfjsLib.getDocument(path);
            loadingTask.onProgress = (p) => {
                const percent = Math.round((p.loaded / p.total) * 100);
                if (!isNaN(percent)) document.getElementById('loading-text').innerText = `åŠ è½½ ${percent}%`;
            };
            const pdf = await loadingTask.promise;
            for (let i = 1; i <= pdf.numPages; i++) {
                await renderPdfPage(pdf, i);
                if (i % 3 === 0) await new Promise(r => setTimeout(r, 50));
            }
            document.getElementById('loading-box').style.display = 'none';
        } catch (err) {
            console.error(err);
            alert("PDF åŠ è½½å¤±è´¥: " + err.message);
            closeReader();
        }
    }

    async function renderPdfPage(pdf, num) {
        const page = await pdf.getPage(num);
        const viewport = page.getViewport({ scale: 1.0 });
        const div = document.createElement('div');
        div.className = 'pdf-page';
        div.style.aspectRatio = `${viewport.width} / ${viewport.height}`;
        document.getElementById('pdf-content-wrapper').appendChild(div);
        const opList = await page.getOperatorList();
        const svgGfx = new pdfjsLib.SVGGraphics(page.commonObjs, page.objs);
        const svg = await svgGfx.getSVG(opList, viewport);
        svg.style.width = "100%"; svg.style.height = "100%";
        div.appendChild(svg);
    }

    window.changeZoom = function(delta) {
        currentScale += delta;
        if (currentScale < 0.5) currentScale = 0.5;
        if (currentScale > 3.0) currentScale = 3.0;
        updatePdfZoom();
    };

    function updatePdfZoom() {
        const wrapper = document.getElementById('pdf-content-wrapper');
        wrapper.style.width = `${currentScale * 100}%`;
        wrapper.style.margin = currentScale <= 1.0 ? "0 auto" : "0";
    }

    window.closeReader = function(isHardwareBack = false) {
        if (!isHardwareBack) history.back();
        iframeView.style.display = 'none';
        pdfView.style.display = 'none';
        homeView.style.display = 'block';
        document.getElementById('content-iframe').src = '';
        document.getElementById('pdf-content-wrapper').innerHTML = '';
        homeView.scrollTop = lastScrollY;
    };

    window.addEventListener('popstate', () => {
        if (iframeView.style.display === 'flex' || pdfView.style.display === 'flex') {
            closeReader(true);
        }
    });

    function showError(msg) {
        const el = document.getElementById('error-modal');
        el.style.display = 'block';
        el.innerText += "\n================\n" + msg;
    }

    // === 3. ğŸŸ¢ å¯åŠ¨é€»è¾‘ (åŒ…å«åœ¨çº¿æ£€æŸ¥) ===
    async function init() {
        // 1. å…ˆåŠ è½½æœ¬åœ°æ•°æ®
        if (typeof LOCAL_DATA !== 'undefined') {
            const data = getRootNodes(LOCAL_DATA);
            if (data) renderTree(data, fileListEl);
        } else {
            showError("ç¦»çº¿æ•°æ® data.js åŠ è½½å¤±è´¥");
        }

        // 2. å°è¯•è”ç½‘æ£€æŸ¥æ›´æ–°
        try {
            console.log("Checking update from:", CDN_ROOT + 'data.js');
            const res = await fetch(CDN_ROOT + 'data.js');
            if (res.ok) {
                const txt = await res.text();
                // æå– JSON
                const jsonStr = txt.substring(txt.indexOf('{'), txt.lastIndexOf('}') + 1);
                const remoteData = JSON.parse(jsonStr);
                
                const localVer = (typeof LOCAL_DATA !== 'undefined') ? Number(LOCAL_DATA.version) : 0;
                const remoteVer = Number(remoteData.version);

                // å¦‚æœè¿œç¨‹ç‰ˆæœ¬æ›´æ–°ï¼Œåˆ‡æ¢åˆ°åœ¨çº¿æ¨¡å¼
                if (remoteVer > localVer) {
                    useOnline = true; // æ ‡è®°ä¸ºåœ¨çº¿
                    const newData = getRootNodes(remoteData);
                    if (newData) {
                        console.log("å‘ç°æ–°ç‰ˆæœ¬ï¼Œåˆ‡æ¢è‡³åœ¨çº¿æ•°æ®");
                        renderTree(newData, fileListEl);
                        
                        // æç¤ºç”¨æˆ·
                        const tag = document.getElementById('version-display');
                        tag.style.background = '#d4edda';
                        tag.style.color = '#155724';
                    }
                }
            }
        } catch (e) {
            console.log("æ— æ³•è¿æ¥åœ¨çº¿æ›´æ–°ï¼Œä¿æŒç¦»çº¿æ¨¡å¼", e);
        }
    }

    init();
</script>
</body>
</html>