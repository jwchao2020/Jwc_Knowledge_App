<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Jwc çŸ¥è¯†åº“</title>
    
    <script src="lib/pdfjs/pdf.min.js"></script>

    <style>
        :root { --primary: #007bff; --bg: #f8f9fa; --text: #333; --card: #fff; }
        [data-theme="dark"] { --primary: #4dabf7; --bg: #121212; --text: #e0e0e0; --card: #1e1e1e; }
        
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; overflow: hidden; }

        /* === é¦–é¡µ === */
        #home-view { 
            height: 100vh; overflow-y: auto; display: block; 
            -webkit-overflow-scrolling: touch;
        }
        
        header { 
            background: var(--primary); color: white; padding: 15px; 
            position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .app-title { font-weight: bold; font-size: 18px; }

        .node { background: var(--card); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .node-title { padding: 16px; display: flex; align-items: center; cursor: pointer; }
        .node-title:active { background: rgba(0,0,0,0.05); }
        .icon { margin-right: 12px; font-size: 20px; }
        .text { flex: 1; font-size: 16px; font-weight: 500; }
        .children { display: none; padding-left: 20px; background: rgba(0,0,0,0.02); }
        .children.show { display: block; }

        /* === iframe é˜…è¯»å™¨ (ç”¨äºæ˜¾ç¤º HTML) === */
        #iframe-view {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 200; flex-direction: column;
        }
        .iframe-container { flex: 1; width: 100%; height: 100%; border: none; }

        /* === PDF é˜…è¯»é¡µé¢ === */
        #pdf-view {
            display: none; 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #525659; z-index: 200;
            flex-direction: column;
        }

        .reader-bar {
            background: #333; color: white; padding: 10px 15px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3); z-index: 201;
        }
        .reader-title { font-size: 14px; max-width: 50%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .close-btn { background: #555; border: none; color: white; padding: 5px 12px; border-radius: 4px; font-size: 14px;}
        
        /* ç¼©æ”¾æ§åˆ¶åŒº */
        .zoom-controls { display: flex; gap: 10px; align-items: center; }
        .zoom-btn { width: 30px; height: 30px; background: #555; border: none; color: white; border-radius: 50%; font-size: 18px; display: flex; justify-content: center; align-items: center;}
        
        /* PDF æ»šåŠ¨å®¹å™¨ */
        #pdf-scroll-container {
            flex: 1; overflow: auto; padding: 20px; position: relative;
            touch-action: pan-x pan-y;
        }
        .pdf-page {
            margin: 0 auto 15px auto; background: white; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            width: 100%; transform-origin: top left;
        }
        .pdf-page svg { width: 100%; height: auto; display: block; }

        .loading-box {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; color: white; pointer-events: none;
        }
    </style>
</head>
<body>

<div id="home-view">
    <header>
        <div class="app-title">ğŸ“š çŸ¥è¯†åº“</div>
        <div id="status-text" style="font-size:12px; opacity:0.8">å‡†å¤‡å°±ç»ª</div>
    </header>
    <div id="file-list"></div>
</div>

<div id="iframe-view">
    <div class="reader-bar">
        <button class="close-btn" onclick="closeReader()">â® è¿”å›</button>
        <span class="reader-title" id="iframe-title">æ–‡æ¡£</span>
        <div style="width: 30px;"></div> </div>
    <iframe id="content-iframe" class="iframe-container" src=""></iframe>
</div>

<div id="pdf-view">
    <div class="reader-bar">
        <button class="close-btn" onclick="closeReader()">â® è¿”å›</button>
        <span class="reader-title" id="doc-title">æ ‡é¢˜</span>
        <div class="zoom-controls">
            <button class="zoom-btn" onclick="changeZoom(-0.2)">ï¼</button>
            <button class="zoom-btn" onclick="changeZoom(0.2)">ï¼‹</button>
        </div>
    </div>
    <div id="pdf-scroll-container">
        <div id="pdf-content-wrapper"></div>
    </div>
    <div id="loading-box" class="loading-box" style="display:none">
        <div style="font-size:20px; margin-bottom:10px;">â³</div>
        <div id="loading-text">åŠ è½½ä¸­...</div>
    </div>
</div>

<script src="data.js"></script>
<script>
    // === ğŸŸ¢ ä¿®æ”¹ 2: é…ç½®æœ¬åœ° Worker ===
    // ç¡®ä¿ pdf.worker.min.js å’Œ index.html åœ¨åŒä¸€ç›®å½•ä¸‹
    if (typeof pdfjsLib !== 'undefined') {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'lib/pdfjs/pdf.worker.min.js';
    }

    // === é…ç½® ===
    const USER = 'jwchao2020';
    const REPO = 'Jwc_Knowledge_App';
    const BRANCH = 'gh-pages';
    // é»˜è®¤ä½¿ç”¨æœ¬åœ°è·¯å¾„ï¼Œåªæœ‰åœ¨æ˜ç¡®éœ€è¦åœ¨çº¿ PDF æ—¶æ‰ç”¨ CDN
    const CDN_ROOT = `https://cdn.jsdelivr.net/gh/${USER}/${REPO}@${BRANCH}/Documents/`;
    const DATA_URL = CDN_ROOT + 'data.js';

    // DOM
    const homeView = document.getElementById('home-view');
    const pdfView = document.getElementById('pdf-view');
    const iframeView = document.getElementById('iframe-view');
    const fileListEl = document.getElementById('file-list');
    const pdfWrapper = document.getElementById('pdf-content-wrapper');
    const scrollContainer = document.getElementById('pdf-scroll-container');
    const statusText = document.getElementById('status-text');

    let useOnline = false;
    let lastScrollPosition = 0;
    let currentScale = 1.0;

    // === ç¼©æ”¾é€»è¾‘ ===
    function changeZoom(delta) {
        let newScale = currentScale + delta;
        if (newScale < 1.0) newScale = 1.0;
        if (newScale > 3.0) newScale = 3.0;
        applyZoom(newScale);
    }
    function applyZoom(scale) {
        currentScale = scale;
        pdfWrapper.style.width = `${currentScale * 100}%`;
        pdfWrapper.style.margin = (currentScale === 1.0) ? "0 auto" : "0";
    }

    // === æ‹¦æˆªè¿”å›é”® ===
    window.addEventListener('popstate', function(event) {
        if (pdfView.style.display === 'flex' || iframeView.style.display === 'flex') {
            closeReader(true); 
        }
    });

    // === æ‰“å¼€æ–‡æ¡£å…¥å£ (æ”¯æŒ PDF å’Œ HTML) ===
    function openDoc(node) {
        // è§£ç  node (ä» onclick ä¼ é€’è¿‡æ¥çš„æ˜¯ base64 æˆ–è€…æ˜¯å¯¹è±¡)
        // è¿™é‡Œç®€åŒ–é€»è¾‘ï¼Œæˆ‘ä»¬å‡è®¾ node æ˜¯ä¼ è¿‡æ¥çš„æ•°æ®å¯¹è±¡
    }

    // === æ‰“å¼€ HTML (æ–°å¢åŠŸèƒ½) ===
    function openHtml(relativePath, title) {
        lastScrollPosition = homeView.scrollTop;
        window.history.pushState({view: 'reader'}, null, '#reader');
        
        homeView.style.display = 'none';
        iframeView.style.display = 'flex';
        document.getElementById('iframe-title').innerText = title;
        
        // ğŸŸ¢ å…³é”®ï¼šç›´æ¥åŠ è½½æœ¬åœ°æ–‡ä»¶
        document.getElementById('content-iframe').src = relativePath;
    }

    // === æ‰“å¼€ PDF ===
    async function openPdf(relativePath, title) {
        if (!useOnline) {
            // å°è¯•æœ¬åœ°åŠ è½½ (è™½ç„¶ PDF æ¯”è¾ƒå¤§ï¼Œä½†å¦‚æœæœ‰æœ¬åœ°è·¯å¾„ä¹Ÿå¯ä»¥å°è¯•)
            // è¿™é‡Œä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬è¿˜æ˜¯æç¤ºè”ç½‘
            if(confirm("PDF æ–‡ä»¶è¾ƒå¤§ï¼Œæ˜¯å¦å°è¯•åœ¨çº¿åŠ è½½ï¼Ÿ")) {
                // ç»§ç»­
            } else {
                return;
            }
        }

        lastScrollPosition = homeView.scrollTop;
        window.history.pushState({view: 'pdf'}, null, '#pdf');

        homeView.style.display = 'none';
        pdfView.style.display = 'flex';
        
        document.getElementById('doc-title').innerText = title;
        pdfWrapper.innerHTML = ''; 
        document.getElementById('loading-box').style.display = 'block';
        applyZoom(1.0);

        try {
            const url = CDN_ROOT + relativePath; // PDF ä»ç„¶å°è¯•ä»åœ¨çº¿åŠ è½½
            const loadingTask = pdfjsLib.getDocument(url);
            loadingTask.onProgress = (p) => {
                const percent = Math.round((p.loaded / p.total) * 100);
                if(!isNaN(percent)) document.getElementById('loading-text').innerText = `ä¸‹è½½ ${percent}%`;
            };

            const pdf = await loadingTask.promise;
            for (let i = 1; i <= pdf.numPages; i++) {
                await renderPageAsSVG(pdf, i);
                if (i % 5 === 0) await new Promise(r => setTimeout(r, 100));
            }
            document.getElementById('loading-box').style.display = 'none';
        } catch (error) {
            console.error(error);
            alert("åŠ è½½ PDF å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ");
            closeReader(true);
        }
    }

    async function renderPageAsSVG(pdf, num) {
        const page = await pdf.getPage(num);
        const viewport = page.getViewport({ scale: 1.0 });
        const pageDiv = document.createElement('div');
        pageDiv.className = 'pdf-page';
        pageDiv.style.aspectRatio = `${viewport.width} / ${viewport.height}`;
        pdfWrapper.appendChild(pageDiv);
        const opList = await page.getOperatorList();
        const svgGfx = new pdfjsLib.SVGGraphics(page.commonObjs, page.objs);
        const svg = await svgGfx.getSVG(opList, viewport);
        pageDiv.appendChild(svg);
    }

    function closeReader(isHardwareBack = false) {
        if (!isHardwareBack) window.history.back();
        pdfView.style.display = 'none';
        iframeView.style.display = 'none';
        homeView.style.display = 'block';
        document.getElementById('content-iframe').src = ''; // æ¸…ç† iframe
        pdfWrapper.innerHTML = ''; 
        homeView.scrollTop = lastScrollPosition;
    }

    // === ç›®å½•æ¸²æŸ“ ===
    function renderTree(nodes, container) {
        nodes.forEach(node => {
            const div = document.createElement('div');
            div.className = 'node';
            
            // ğŸŸ¢ ä¿®æ”¹ 3: é€‚é… HTML å’Œ PDF ä¸¤ç§æ ¼å¼
            // æˆ‘ä»¬ä¹‹å‰çš„è„šæœ¬ç”Ÿæˆçš„æ˜¯ .html æ–‡ä»¶ï¼Œæ‰€ä»¥åœ¨ json é‡Œé€šå¸¸æ˜¯ node.url æˆ– node.path
            // è¿™é‡Œåšä¸€ä¸ªç®€å•çš„åˆ¤æ–­
            const targetPath = node.url || node.pdf || node.path;
            
            if (targetPath) {
                // æ˜¯æ–‡ä»¶
                const isPdf = targetPath.toLowerCase().endsWith('.pdf');
                const icon = isPdf ? 'ğŸ“„' : 'ğŸŒ';
                const clickAction = isPdf ? 
                    `openPdf('${targetPath}', '${node.title}')` : 
                    `openHtml('${targetPath}', '${node.title}')`;

                div.innerHTML = `<div class="node-title" onclick="${clickAction}"><span class="icon">${icon}</span><span class="text">${node.title}</span></div>`;
            } else {
                // æ˜¯æ–‡ä»¶å¤¹
                const id = 'g-' + Math.random().toString(36).substr(2,9);
                div.innerHTML = `<div class="node-title" onclick="toggle('${id}', this)"><span class="icon">ğŸ“‚</span><span class="text">${node.title}</span></div><div class="children" id="${id}"></div>`;
                container.appendChild(div);
                if (node.children) renderTree(node.children, div.querySelector('.children'));
                return; 
            }
            container.appendChild(div);
        });
    }

    window.toggle = (id, el) => {
        const child = document.getElementById(id);
        child.classList.toggle('show');
        el.style.backgroundColor = child.classList.contains('show') ? 'rgba(0,0,0,0.05)' : '';
    };

    // === åˆå§‹åŒ– ===
    async function init() {
        // 1. ä¼˜å…ˆåŠ è½½æœ¬åœ°æ•°æ® (data.js)
        if (typeof LOCAL_DATA !== 'undefined') {
            console.log("åŠ è½½æœ¬åœ°æ•°æ®...");
            renderTree(LOCAL_DATA.tree, fileListEl);
        } else {
            statusText.innerText = "æ— æœ¬åœ°æ•°æ®";
        }

        // 2. å°è¯•è”ç½‘æ›´æ–° (é™é»˜æ›´æ–°ï¼Œä¸é˜»å¡ç•Œé¢)
        try {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), 3000); // 3ç§’è¶…æ—¶
            
            const res = await fetch(DATA_URL, { signal: controller.signal });
            clearTimeout(id);
            
            if(res.ok) {
                const txt = await res.text();
                // æå– JSON
                const jsonStr = txt.substring(txt.indexOf('{'), txt.lastIndexOf('}')+1);
                const json = JSON.parse(jsonStr);
                
                // åªæœ‰ç‰ˆæœ¬æ›´æ–°æ‰åˆ·æ–°ç•Œé¢
                const localVer = (typeof LOCAL_DATA !== 'undefined') ? Number(LOCAL_DATA.version) : 0;
                if (Number(json.version) > localVer) {
                    useOnline = true;
                    statusText.innerText = "ğŸŸ¢ åœ¨çº¿ v" + json.version;
                    statusText.style.color = "#28a745";
                    fileListEl.innerHTML = ''; 
                    renderTree(json.tree, fileListEl);
                }
            }
        } catch(e) { 
            console.log("ç¦»çº¿æ¨¡å¼æˆ–ç½‘ç»œä¸ä½³");
            // ä¿æŒæœ¬åœ°æ•°æ®ä¸åŠ¨ï¼Œç•Œé¢ä¸ä¼šå¡ä½
        }
    }

    init();
</script>
</body>
</html>