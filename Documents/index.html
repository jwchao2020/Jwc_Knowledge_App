<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Jwc çŸ¥è¯†åº“</title>
    
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>

    <style>
        :root { --primary: #007bff; --bg: #f8f9fa; --text: #333; --card: #fff; }
        [data-theme="dark"] { --primary: #4dabf7; --bg: #121212; --text: #e0e0e0; --card: #1e1e1e; }
        
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; overflow: hidden; /* ç¦æ­¢æ•´ä½“æ»šåŠ¨ï¼Œç”±å­è§†å›¾æ¥ç®¡ */ }

        /* === é¦–é¡µ === */
        #home-view { 
            height: 100vh; overflow-y: auto; display: block; 
            -webkit-overflow-scrolling: touch;
        }
        
        header { 
            background: var(--primary); color: white; padding: 15px; 
            position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .app-title { font-weight: bold; font-size: 18px; }

        .node { background: var(--card); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .node-title { padding: 16px; display: flex; align-items: center; cursor: pointer; }
        .node-title:active { background: rgba(0,0,0,0.05); }
        .icon { margin-right: 12px; font-size: 20px; }
        .text { flex: 1; font-size: 16px; font-weight: 500; }
        .children { display: none; padding-left: 20px; background: rgba(0,0,0,0.02); }
        .children.show { display: block; }

        /* === ğŸ“– é˜…è¯»é¡µé¢ === */
        #pdf-view {
            display: none; 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #e0e0e0; z-index: 200;
            flex-direction: column;
        }

        .reader-bar {
            background: #333; color: white; padding: 10px 15px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3); z-index: 201;
        }
        .reader-title { font-size: 14px; max-width: 50%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .close-btn { background: #555; border: none; color: white; padding: 5px 12px; border-radius: 4px; font-size: 14px;}
        
        /* ç¼©æ”¾æ§åˆ¶åŒº */
        .zoom-controls { display: flex; gap: 10px; align-items: center; }
        .zoom-btn { width: 30px; height: 30px; background: #555; border: none; color: white; border-radius: 50%; font-size: 18px; display: flex; justify-content: center; align-items: center;}
        
        /* PDF æ»šåŠ¨å®¹å™¨ */
        #pdf-scroll-container {
            flex: 1; overflow: auto; /* å…è®¸åŒå‘æ»šåŠ¨ */
            -webkit-overflow-scrolling: touch;
            padding: 20px;
            position: relative;
            background-color: #525659;
            touch-action: pan-x pan-y; /* å…è®¸æ‰‹æŒ‡æ‹–åŠ¨ */
        }

        /* æ¯ä¸€é¡µ */
        .pdf-page {
            margin: 0 auto 15px auto;
            background: white; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            /* ğŸŸ¢ å…³é”®ï¼šå®½åº¦ç”± JS åŠ¨æ€æ§åˆ¶ */
            width: 100%; 
            transform-origin: top left;
        }
        .pdf-page svg { width: 100%; height: auto; display: block; }

        .loading-box {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; color: white; pointer-events: none;
        }
    </style>
</head>
<body>

<div id="home-view">
    <header>
        <div class="app-title">ğŸ“š çŸ¥è¯†åº“</div>
        <div id="status-text" style="font-size:12px; opacity:0.8">è¿æ¥ä¸­...</div>
    </header>
    <div id="file-list"></div>
</div>

<div id="pdf-view">
    <div class="reader-bar">
        <button class="close-btn" onclick="closePdf()">â® è¿”å›</button>
        <span class="reader-title" id="doc-title">æ ‡é¢˜</span>
        
        <div class="zoom-controls">
            <button class="zoom-btn" onclick="changeZoom(-0.2)">ï¼</button>
            <button class="zoom-btn" onclick="changeZoom(0.2)">ï¼‹</button>
        </div>
    </div>
    
    <div id="pdf-scroll-container">
        <div id="pdf-content-wrapper">
            </div>
    </div>

    <div id="loading-box" class="loading-box" style="display:none">
        <div style="font-size:20px; margin-bottom:10px;">â³</div>
        <div id="loading-text">åŠ è½½ä¸­...</div>
    </div>
</div>

<script src="data.js"></script>
<script>
    // === é…ç½® ===
    const USER = 'jwchao2020';
    const REPO = 'Jwc_Knowledge_App';
    const BRANCH = 'main'; 
    const CDN_ROOT = `https://cdn.jsdelivr.net/gh/${USER}/${REPO}@${BRANCH}/Documents/`;
    const DATA_URL = CDN_ROOT + 'data.js';

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';

    // DOM
    const homeView = document.getElementById('home-view');
    const pdfView = document.getElementById('pdf-view');
    const fileListEl = document.getElementById('file-list');
    const pdfWrapper = document.getElementById('pdf-content-wrapper');
    const scrollContainer = document.getElementById('pdf-scroll-container');
    const titleEl = document.getElementById('doc-title');
    const loadingBox = document.getElementById('loading-box');
    const loadingText = document.getElementById('loading-text');
    const statusText = document.getElementById('status-text');

    let useOnline = false;
    let lastScrollPosition = 0;
    
    // === ğŸ” ç¼©æ”¾é€»è¾‘ (æ ¸å¿ƒ) ===
    let currentScale = 1.0; // 1.0 = 100% å®½åº¦
    
    function changeZoom(delta) {
        let newScale = currentScale + delta;
        if (newScale < 1.0) newScale = 1.0; // æœ€å° 100%
        if (newScale > 3.0) newScale = 3.0; // æœ€å¤§ 300%
        applyZoom(newScale);
    }

    function applyZoom(scale) {
        currentScale = scale;
        // ç›´æ¥ä¿®æ”¹ Wrapper çš„å®½åº¦ç™¾åˆ†æ¯”
        // 1.0 -> 100%, 1.5 -> 150%
        pdfWrapper.style.width = `${currentScale * 100}%`;
        
        // ç¼©æ”¾æ—¶ä¿æŒå±…ä¸­ (å¦‚æœæ˜¯ç¼©å°)
        if (currentScale === 1.0) {
            pdfWrapper.style.margin = "0 auto";
        } else {
            pdfWrapper.style.margin = "0"; // æ”¾å¤§åé å·¦å¯¹é½ï¼Œå…è®¸æ»šåŠ¨
        }
    }

    // === ğŸ‘† æ‰‹åŠ¿ç¼©æ”¾ç›‘å¬ (Pinch) ===
    let initialDistance = 0;
    let initialScale = 1.0;

    scrollContainer.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
            e.preventDefault(); // é˜²æ­¢æµè§ˆå™¨é»˜è®¤è¡Œä¸º
            initialDistance = getDistance(e.touches);
            initialScale = currentScale;
        }
    }, { passive: false });

    scrollContainer.addEventListener('touchmove', (e) => {
        if (e.touches.length === 2) {
            e.preventDefault();
            const currentDistance = getDistance(e.touches);
            if (initialDistance > 0) {
                const ratio = currentDistance / initialDistance;
                // è®¡ç®—æ–°æ¯”ä¾‹
                let newScale = initialScale * ratio;
                // é™åˆ¶èŒƒå›´
                if (newScale < 1.0) newScale = 1.0; 
                if (newScale > 3.0) newScale = 3.0;
                applyZoom(newScale);
            }
        }
    }, { passive: false });

    function getDistance(touches) {
        const dx = touches[0].clientX - touches[1].clientX;
        const dy = touches[0].clientY - touches[1].clientY;
        return Math.sqrt(dx * dx + dy * dy);
    }

    // === æ‹¦æˆªç‰©ç†è¿”å›é”® ===
    window.addEventListener('popstate', function(event) {
        if (pdfView.style.display === 'flex') {
            closePdf(true); 
        }
    });

    // === æ‰“å¼€ PDF ===
    async function openPdf(relativePath, title) {
        if (!useOnline) {
            alert("âš ï¸ éœ€è¦è”ç½‘åŠ è½½é«˜æ¸…æ–‡æ¡£");
            return;
        }

        lastScrollPosition = homeView.scrollTop;
        window.history.pushState({view: 'pdf'}, null, '#pdf');

        homeView.style.display = 'none';
        pdfView.style.display = 'flex';
        
        // é‡ç½®çŠ¶æ€
        titleEl.innerText = title;
        pdfWrapper.innerHTML = ''; 
        loadingBox.style.display = 'block';
        loadingText.innerText = "å‡†å¤‡åŠ è½½...";
        applyZoom(1.0); // é‡ç½®ç¼©æ”¾

        try {
            const url = CDN_ROOT + relativePath;
            const loadingTask = pdfjsLib.getDocument(url);
            
            loadingTask.onProgress = (p) => {
                const percent = Math.round((p.loaded / p.total) * 100);
                if(!isNaN(percent)) loadingText.innerText = `ä¸‹è½½ ${percent}%`;
            };

            const pdf = await loadingTask.promise;
            loadingText.innerText = "æ¸²æŸ“ä¸­...";

            for (let i = 1; i <= pdf.numPages; i++) {
                await renderPageAsSVG(pdf, i);
                if (i % 5 === 0) await new Promise(r => setTimeout(r, 100));
            }
            loadingBox.style.display = 'none';

        } catch (error) {
            console.error(error);
            loadingText.innerHTML = "âŒ åŠ è½½å¤±è´¥";
        }
    }

    async function renderPageAsSVG(pdf, num) {
        const page = await pdf.getPage(num);
        const viewport = page.getViewport({ scale: 1.0 });

        const pageDiv = document.createElement('div');
        pageDiv.className = 'pdf-page';
        // ä¿æŒå®½é«˜æ¯”
        pageDiv.style.aspectRatio = `${viewport.width} / ${viewport.height}`;
        pdfWrapper.appendChild(pageDiv);

        const opList = await page.getOperatorList();
        const svgGfx = new pdfjsLib.SVGGraphics(page.commonObjs, page.objs);
        const svg = await svgGfx.getSVG(opList, viewport);
        
        pageDiv.appendChild(svg);
    }

    function closePdf(isHardwareBack = false) {
        if (!isHardwareBack) window.history.back();

        pdfView.style.display = 'none';
        homeView.style.display = 'block';
        pdfWrapper.innerHTML = ''; 
        homeView.scrollTop = lastScrollPosition;
    }

    // === åˆå§‹åŒ– & ç›®å½• ===
    function renderTree(nodes, container) {
        nodes.forEach(node => {
            const div = document.createElement('div');
            div.className = 'node';
            if (node.pdf) {
                div.innerHTML = `<div class="node-title" onclick="openPdf('${node.pdf}', '${node.title}')"><span class="icon">ğŸ“„</span><span class="text">${node.title}</span></div>`;
            } else {
                const id = 'g-' + Math.random().toString(36).substr(2,9);
                div.innerHTML = `<div class="node-title" onclick="toggle('${id}', this)"><span class="icon">ğŸ“‚</span><span class="text">${node.title}</span></div><div class="children" id="${id}"></div>`;
                container.appendChild(div);
                if (node.children) renderTree(node.children, div.querySelector('.children'));
                return; 
            }
            container.appendChild(div);
        });
    }
    window.toggle = (id, el) => {
        const child = document.getElementById(id);
        child.classList.toggle('show');
        el.style.backgroundColor = child.classList.contains('show') ? 'rgba(0,0,0,0.05)' : '';
    };

    async function init() {
        if (typeof LOCAL_DATA !== 'undefined') renderTree(LOCAL_DATA.tree, fileListEl);
        try {
            const res = await fetch(DATA_URL);
            if(res.ok) {
                const txt = await res.text();
                const json = JSON.parse(txt.substring(txt.indexOf('{'), txt.lastIndexOf('}')+1));
                const localVer = (typeof LOCAL_DATA !== 'undefined') ? Number(LOCAL_DATA.version) : 0;
                if (Number(json.version) >= localVer) {
                    useOnline = true;
                    statusText.innerText = "ğŸŸ¢ åœ¨çº¿ v" + json.version.toString().slice(-4);
                    statusText.style.color = "#81ff98";
                    fileListEl.innerHTML = ''; 
                    renderTree(json.tree, fileListEl);
                }
            }
        } catch(e) { statusText.innerText = "âšª ç¦»çº¿æ¨¡å¼"; }
    }

    init();
</script>
</body>
</html>