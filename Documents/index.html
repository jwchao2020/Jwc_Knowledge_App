<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Jwc çŸ¥è¯†åº“</title>
    
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>

    <style>
        :root { --primary: #007bff; --bg: #f8f9fa; --text: #333; --card: #fff; }
        [data-theme="dark"] { --primary: #4dabf7; --bg: #121212; --text: #e0e0e0; --card: #1e1e1e; }
        
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; }

        /* === é¦–é¡µï¼šæ–‡ä»¶åˆ—è¡¨ === */
        #home-view { display: block; padding-bottom: 40px; }
        
        header { 
            background: var(--primary); color: white; padding: 15px; 
            position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .app-title { font-weight: bold; font-size: 18px; }

        .node { background: var(--card); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .node-title { padding: 16px; display: flex; align-items: center; cursor: pointer; }
        .node-title:active { background: rgba(0,0,0,0.05); }
        .icon { margin-right: 12px; font-size: 20px; }
        .text { flex: 1; font-size: 16px; font-weight: 500; }
        .children { display: none; padding-left: 20px; background: rgba(0,0,0,0.02); }
        .children.show { display: block; }

        /* === ğŸ“– é˜…è¯»é¡µé¢ (å…³é”®ä¿®æ”¹) === */
        /* ä¸å†ä½¿ç”¨ fixed å®šä½ï¼Œè€Œæ˜¯ä½œä¸ºä¸€ä¸ªæ™®é€šçš„é¡µé¢å—ï¼Œå…è®¸ Body æ»šåŠ¨ */
        #pdf-view {
            display: none; 
            min-height: 100vh; background: #525659;
            flex-direction: column;
        }

        /* é˜…è¯»å™¨é¡¶éƒ¨æ  */
        .reader-bar {
            background: #333; color: white; padding: 10px 15px;
            position: sticky; top: 0; z-index: 200; /* å§‹ç»ˆå¸é¡¶ */
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .reader-title { font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 60%; }
        .close-btn { background: none; border: none; color: white; font-size: 16px; padding: 5px 10px; border: 1px solid #666; border-radius: 4px; }
        
        /* PDF å†…å®¹å®¹å™¨ */
        #pdf-content {
            padding: 10px 0; 
            /* ğŸŸ¢ å…³é”®ï¼šç§»é™¤ overflow-yï¼Œè®©å†…å®¹æ’‘å¼€ Bodyï¼Œè§¦å‘åŸç”Ÿç¼©æ”¾ */
            overflow: visible; 
        }

        /* çŸ¢é‡é¡µé¢ */
        .pdf-page {
            position: relative; margin: 0 auto 10px auto;
            background: white; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            width: 100%; max-width: 100%;
        }
        .pdf-page svg { width: 100%; height: auto; display: block; }

        /* åŠ è½½æç¤º */
        .loading-box {
            padding: 50px; text-align: center; color: white;
        }
        .spinner {
            width: 30px; height: 30px; border: 3px solid #999; 
            border-top: 3px solid #fff; border-radius: 50%; 
            animation: spin 1s infinite linear; margin: 0 auto 15px auto;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="home-view">
    <header>
        <div class="app-title">ğŸ“š çŸ¥è¯†åº“</div>
        <div id="status-text" style="font-size:12px; opacity:0.8">è¿æ¥ä¸­...</div>
    </header>
    <div id="file-list"></div>
</div>

<div id="pdf-view">
    <div class="reader-bar">
        <button class="close-btn" onclick="closePdf()">â® è¿”å›</button>
        <span class="reader-title" id="doc-title">æ–‡æ¡£æ ‡é¢˜</span>
        <div style="width: 50px; text-align: right; font-size: 12px; color: #aaa;" id="page-num"></div>
    </div>
    
    <div id="pdf-content">
        </div>

    <div id="loading-box" class="loading-box" style="display:none">
        <div class="spinner"></div>
        <div id="loading-text">æ­£åœ¨ä¸‹è½½...</div>
    </div>
</div>

<script src="data.js"></script>
<script>
    // === é…ç½®åŒºåŸŸ ===
    const USER = 'jwchao2020';
    const REPO = 'Jwc_Knowledge_App';
    const BRANCH = 'main'; 
    const CDN_ROOT = `https://cdn.jsdelivr.net/gh/${USER}/${REPO}@${BRANCH}/Documents/`;
    const DATA_URL = CDN_ROOT + 'data.js';

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';

    // DOM
    const homeView = document.getElementById('home-view');
    const pdfView = document.getElementById('pdf-view');
    const fileListEl = document.getElementById('file-list');
    const pdfContent = document.getElementById('pdf-content');
    const titleEl = document.getElementById('doc-title');
    const loadingBox = document.getElementById('loading-box');
    const loadingText = document.getElementById('loading-text');
    const statusText = document.getElementById('status-text');
    const pageNumEl = document.getElementById('page-num');

    let useOnline = false;

    // === æ‰“å¼€ PDF (SVG æ¨¡å¼) ===
    async function openPdf(relativePath, title) {
        if (!useOnline) {
            alert("âš ï¸ éœ€è¦è”ç½‘æ‰èƒ½ä½¿ç”¨é«˜æ¸…çŸ¢é‡é˜…è¯»æ¨¡å¼");
            return;
        }

        // ğŸŸ¢ åˆ‡æ¢è§†å›¾ï¼šéšè—é¦–é¡µï¼Œæ˜¾ç¤º PDF é¡µ
        // è¿™æ · PDF å†…å®¹å°±æˆä¸ºäº†é¡µé¢çš„ä¸»ä½“ï¼Œæµè§ˆå™¨å°±ä¼šå…è®¸ä½ å¯¹å®ƒè¿›è¡Œç¼©æ”¾
        homeView.style.display = 'none';
        pdfView.style.display = 'flex';
        window.scrollTo(0, 0); //ä»¥æ­¤é‡ç½®æ»šåŠ¨æ¡

        titleEl.innerText = title;
        pdfContent.innerHTML = ''; 
        loadingBox.style.display = 'block';
        loadingText.innerText = "å‡†å¤‡åŠ è½½...";
        pageNumEl.innerText = "";

        try {
            const url = CDN_ROOT + relativePath;
            const loadingTask = pdfjsLib.getDocument(url);
            
            loadingTask.onProgress = (p) => {
                const percent = Math.round((p.loaded / p.total) * 100);
                if(!isNaN(percent)) loadingText.innerText = `ä¸‹è½½ ${percent}%`;
            };

            const pdf = await loadingTask.promise;
            loadingText.innerText = "æ­£åœ¨æ¸²æŸ“...";
            pageNumEl.innerText = `å…± ${pdf.numPages} é¡µ`;

            // æ¸²æŸ“æ‰€æœ‰é¡µé¢
            for (let i = 1; i <= pdf.numPages; i++) {
                await renderPageAsSVG(pdf, i);
                // ç®€å•çš„ç¼“å†²
                if (i > 3) await new Promise(r => setTimeout(r, 50));
            }
            loadingBox.style.display = 'none';

        } catch (error) {
            console.error(error);
            loadingText.innerHTML = "åŠ è½½å¤±è´¥<br>" + error.message;
        }
    }

    // SVG æ¸²æŸ“å™¨
    async function renderPageAsSVG(pdf, num) {
        const page = await pdf.getPage(num);
        const viewport = page.getViewport({ scale: 1.0 });

        const pageDiv = document.createElement('div');
        pageDiv.className = 'pdf-page';
        // ä¿æŒå®½é«˜æ¯”
        pageDiv.style.aspectRatio = `${viewport.width} / ${viewport.height}`;
        pdfContent.appendChild(pageDiv);

        const opList = await page.getOperatorList();
        const svgGfx = new pdfjsLib.SVGGraphics(page.commonObjs, page.objs);
        const svg = await svgGfx.getSVG(opList, viewport);
        
        pageDiv.appendChild(svg);
    }

    // å…³é—­ PDF
    function closePdf() {
        pdfView.style.display = 'none';
        homeView.style.display = 'block';
        pdfContent.innerHTML = ''; // æ¸…ç†å†…å­˜
    }

    // ç›®å½•æ¸²æŸ“
    function renderTree(nodes, container) {
        nodes.forEach(node => {
            const div = document.createElement('div');
            div.className = 'node';
            if (node.pdf) {
                div.innerHTML = `<div class="node-title" onclick="openPdf('${node.pdf}', '${node.title}')"><span class="icon">ğŸ“„</span><span class="text">${node.title}</span></div>`;
            } else {
                const id = 'g-' + Math.random().toString(36).substr(2,9);
                div.innerHTML = `
                    <div class="node-title" onclick="toggle('${id}', this)">
                        <span class="icon">ğŸ“‚</span><span class="text">${node.title}</span>
                    </div>
                    <div class="children" id="${id}"></div>`;
                container.appendChild(div);
                if (node.children) renderTree(node.children, div.querySelector('.children'));
                return; 
            }
            container.appendChild(div);
        });
    }
    window.toggle = (id, el) => {
        const child = document.getElementById(id);
        child.classList.toggle('show');
        el.style.backgroundColor = child.classList.contains('show') ? 'rgba(0,0,0,0.05)' : '';
    };

    // åˆå§‹åŒ–
    async function init() {
        if (typeof LOCAL_DATA !== 'undefined') renderTree(LOCAL_DATA.tree, fileListEl);
        
        try {
            const res = await fetch(DATA_URL);
            if(res.ok) {
                const txt = await res.text();
                const json = JSON.parse(txt.substring(txt.indexOf('{'), txt.lastIndexOf('}')+1));
                
                const localVer = (typeof LOCAL_DATA !== 'undefined') ? Number(LOCAL_DATA.version) : 0;
                if (Number(json.version) >= localVer) {
                    useOnline = true;
                    statusText.innerText = "ğŸŸ¢ åœ¨çº¿ (v" + json.version.toString().slice(-4) + ")";
                    statusText.style.color = "#81ff98";
                    fileListEl.innerHTML = ''; 
                    renderTree(json.tree, fileListEl);
                }
            }
        } catch(e) { 
            statusText.innerText = "âšª ç¦»çº¿æ¨¡å¼";
        }
    }

    init();
</script>
</body>
</html>