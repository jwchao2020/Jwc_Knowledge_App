<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jwc çŸ¥è¯†åº“</title>
    
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>

    <style>
        /* === åŸºç¡€å¸ƒå±€ === */
        body { font-family: -apple-system, sans-serif; background: #f5f5f5; margin: 0; padding-bottom: 20px;}
        header { background: #007bff; color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);}
        .status-badge { font-size: 12px; padding: 4px 10px; border-radius: 12px; background: rgba(255,255,255,0.2); font-weight: bold;}
        
        /* === ç›®å½•æ ‘æ ·å¼ === */
        .node { background: white; border-bottom: 1px solid #eee; }
        .node-title { padding: 16px; display: flex; align-items: center; cursor: pointer; transition: background 0.1s; }
        .node-title:active { background: #f2f2f2; }
        .icon { margin-right: 12px; font-size: 18px;}
        .text { flex: 1; color: #333; font-size: 16px; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
        .arrow { color: #ccc; transition: transform 0.2s; font-size: 14px;}
        .arrow.open { transform: rotate(90deg); }
        .children { display: none; padding-left: 15px; background: #fafafa; }
        .children.show { display: block; }
        .is-file .icon { color: #e74c3c; }

        /* === 2. PDF é˜…è¯»å™¨å¼¹çª—æ ·å¼ (æ–°å¢) === */
        #pdf-modal {
            display: none; /* é»˜è®¤éšè— */
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #333; z-index: 999; flex-direction: column;
        }
        
        /* é¡¶éƒ¨å·¥å…·æ  */
        #pdf-header {
            background: #222; color: white; padding: 12px 15px; 
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        #pdf-title { font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 80%; }
        .close-btn { 
            background: none; border: none; color: white; font-size: 28px; line-height: 1; 
            cursor: pointer; padding: 0 5px;
        }

        /* PDF å†…å®¹å®¹å™¨ */
        #pdf-container {
            flex: 1; overflow-y: auto; /* å…è®¸å‚ç›´æ»šåŠ¨ */
            padding: 10px; box-sizing: border-box;
            -webkit-overflow-scrolling: touch; /* iOS é¡ºæ»‘æ»šåŠ¨ */
        }

        /* æ¯ä¸€é¡µ PDF */
        canvas {
            display: block; margin: 0 auto 10px auto; 
            max-width: 100%; /* å®½åº¦è‡ªé€‚åº”å±å¹• */
            box-shadow: 0 2px 5px rgba(0,0,0,0.5); /* ç»™çº¸å¼ åŠ é˜´å½± */
            background: white;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading-msg { color: #ccc; text-align: center; margin-top: 50%; transform: translateY(-50%); }
    </style>
</head>
<body>

<header>
    <span>ğŸ“š çŸ¥è¯†åº“</span>
    <span id="status" class="status-badge">è¿æ¥ä¸­...</span>
</header>

<div id="app"></div>

<div id="pdf-modal">
    <div id="pdf-header">
        <span id="pdf-title">æ–‡æ¡£é¢„è§ˆ</span>
        <button class="close-btn" onclick="closePdf()">Ã—</button>
    </div>
    <div id="pdf-container">
        </div>
</div>

<script src="data.js"></script>

<script>
    // === 4. é…ç½®åŒºåŸŸ (è¯·ç¡®è®¤è¿™é‡Œæ˜¯ä½ çš„ GitHub ä¿¡æ¯) ===
    const USER = 'jwchao2020'; 
    const REPO = 'Jwc_Knowledge_App';
    const BRANCH = 'main'; 

    const CDN_ROOT = `https://cdn.jsdelivr.net/gh/${USER}/${REPO}@${BRANCH}/Documents/`;
    const DATA_URL = CDN_ROOT + 'data.js';

    // 5. è®¾ç½® PDF.js çš„ Worker (å¿…é¡»æ­¥éª¤ï¼Œç”¨äºåå°è§£æ)
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';

    const app = document.getElementById('app');
    const statusLabel = document.getElementById('status');
    const pdfModal = document.getElementById('pdf-modal');
    const pdfContainer = document.getElementById('pdf-container');
    const pdfTitleLabel = document.getElementById('pdf-title');
    let useOnline = false;

    // === æ ¸å¿ƒåŠŸèƒ½ï¼šæ‰“å¼€ PDF ===
    async function openPdf(relativePath, title) {
        // å¦‚æœæ˜¯ç¦»çº¿ï¼Œæ— æ³•ä½¿ç”¨åœ¨çº¿è§£æå™¨ (å› ä¸º JS æ— æ³•è¯»å–æœ¬åœ° file:// åè®®çš„æ–‡ä»¶æµ)
        if (!useOnline) {
            alert("âš ï¸ ç¦»çº¿æ¨¡å¼é™åˆ¶ï¼š\nä¸ºäº†èŠ‚çœæµé‡å’ŒåŒ…ä½“ç§¯ï¼Œå†…ç½®é˜…è¯»å™¨éœ€è¦è”ç½‘åŠ è½½ã€‚\nè¯·è¿æ¥ç½‘ç»œåé‡è¯•ï¼");
            return;
        }

        const url = CDN_ROOT + relativePath;

        // 1. æ˜¾ç¤ºç•Œé¢
        pdfModal.style.display = 'flex';
        pdfTitleLabel.innerText = title;
        pdfContainer.innerHTML = '<div class="loading-msg">â³ æ­£åœ¨åŠ è½½æ–‡æ¡£...<br>è¯·ç¨å€™</div>';

        try {
            // 2. è·å–æ–‡æ¡£
            const loadingTask = pdfjsLib.getDocument(url);
            const pdf = await loadingTask.promise;
            
            pdfContainer.innerHTML = ''; // æ¸…é™¤åŠ è½½æç¤º

            // 3. å¾ªç¯æ¸²æŸ“æ¯ä¸€é¡µ
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                const page = await pdf.getPage(pageNum);
                
                // 4. è®¡ç®—ç¼©æ”¾ (Scale)
                // æ‰‹æœºå±å¹•åƒç´ å¯†åº¦é«˜ï¼Œç”¨ 1.5 æˆ– 2.0 å€æ¸²æŸ“ä¼šæ›´æ¸…æ™°ï¼Œç„¶å CSS ç¼©å°æ˜¾ç¤º
                const viewport = page.getViewport({scale: 1.5});

                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                pdfContainer.appendChild(canvas);

                // 5. æ¸²æŸ“é¡µé¢
                await page.render({
                    canvasContext: context,
                    viewport: viewport
                }).promise;
            }

        } catch (error) {
            console.error("PDF Load Error:", error);
            pdfContainer.innerHTML = '<div class="loading-msg" style="color:#ff6b6b">âŒ åŠ è½½å¤±è´¥<br>è¯·æ£€æŸ¥ç½‘ç»œæˆ–æ–‡æ¡£å®Œæ•´æ€§</div>';
        }
    }

    // å…³é—­é˜…è¯»å™¨
    function closePdf() {
        pdfModal.style.display = 'none';
        pdfContainer.innerHTML = ''; // æ¸…ç©ºå†…å®¹é‡Šæ”¾å†…å­˜
    }

    // === æ¸²æŸ“ç›®å½•æ ‘ ===
    function renderTree(nodes, container, isRoot = false) {
        if(isRoot) container.innerHTML = ''; 
        
        nodes.forEach(node => {
            const nodeDiv = document.createElement('div');
            nodeDiv.className = 'node';

            if (node.pdf) {
                nodeDiv.classList.add('is-file');
                // æ³¨æ„ï¼šè¿™é‡Œä¿®æ”¹ä¸ºè°ƒç”¨ openPdfï¼Œä¼ å…¥ è·¯å¾„ å’Œ æ ‡é¢˜
                nodeDiv.innerHTML = `
                    <div class="node-title" onclick="openPdf('${node.pdf}', '${node.title}')">
                        <span class="icon">ğŸ“„</span>
                        <span class="text">${node.title}</span>
                        <span class="arrow">ğŸ‘ï¸</span>
                    </div>
                `;
            } else {
                const titleDiv = document.createElement('div');
                titleDiv.className = 'node-title';
                titleDiv.innerHTML = `<span class="icon">ğŸ“‚</span><span class="text">${node.title}</span><span class="arrow">â€º</span>`;
                const childrenContainer = document.createElement('div');
                childrenContainer.className = 'children';
                
                titleDiv.onclick = () => {
                    const arrow = titleDiv.querySelector('.arrow');
                    const isOpen = childrenContainer.classList.contains('show');
                    if(isOpen) {
                        childrenContainer.classList.remove('show');
                        arrow.classList.remove('open');
                    } else {
                        childrenContainer.classList.add('show');
                        arrow.classList.add('open');
                    }
                };
                
                nodeDiv.appendChild(titleDiv);
                nodeDiv.appendChild(childrenContainer);
                if (node.children) renderTree(node.children, childrenContainer);
            }
            container.appendChild(nodeDiv);
        });
    }

    // === åˆå§‹åŒ–é€»è¾‘ ===
    async function init() {
        if (typeof LOCAL_DATA !== 'undefined') {
            renderTree(LOCAL_DATA.tree, app, true);
            statusLabel.innerText = "âšª ç¦»çº¿æ¨¡å¼";
        }
        try {
            // ä½¿ç”¨ jsDelivr é«˜é€Ÿ CDN
            const response = await fetch(DATA_URL);
            if (!response.ok) throw new Error("Net Error");
            
            const scriptText = await response.text();
            const jsonStr = scriptText.substring(scriptText.indexOf('{'), scriptText.lastIndexOf('}') + 1);
            const remoteData = JSON.parse(jsonStr);
            
            const localVer = (typeof LOCAL_DATA !== 'undefined') ? Number(LOCAL_DATA.version) : 0;
            const remoteVer = Number(remoteData.version);

            if (remoteVer >= localVer) {
                useOnline = true;
                statusLabel.innerText = "ğŸŸ¢ åœ¨çº¿ (å†…éƒ¨é˜…è¯»)";
                statusLabel.style.background = "#28a745";
                renderTree(remoteData.tree, app, true);
            }
        } catch (e) {
            statusLabel.innerText = "âšª ç¦»çº¿ (æ— æ³•è¿æ¥)";
        }
    }

    init();
</script>
</body>
</html>