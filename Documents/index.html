<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>Jwc 知识库 (Fixed)</title>

<script src="lib/pdfjs/pdf.min.js"></script>
<script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<style>
/* 样式与原来完全一致，未改 */
body{margin:0;font-family:-apple-system,BlinkMacSystemFont}
#edge-swipe-handler{
  position:fixed;left:0;top:0;width:40px;height:100%;
  z-index:9999;background:rgba(0,0,0,0.01);
}
</style>
</head>

<body>

<div id="edge-swipe-handler"></div>
<div id="sidebar"></div>

<div id="main-area">
  <div id="top-bar">
    <button id="back-btn" onclick="handleCustomBack()">←</button>
    <span id="page-title">首页</span>
  </div>

  <div id="grid-view"></div>
  <div id="html-view" style="display:none"><div id="html-content"></div></div>
  <div id="pdf-view" style="display:none"><div id="pdf-container"></div></div>
</div>

<script src="data.js"></script>

<script>
/* ===================== 基础状态 ===================== */
let currentMode = 'grid';
let historyStack = [];
let lastBackTime = 0;

/* ===================== history 安全封装 ===================== */
function safePush(state, url) {
  try { history.pushState(state, '', url); } catch {}
}

/* ===================== 初始化 ===================== */
function initApp() {
  history.replaceState({ type:'root' }, '', '#home');
  renderGrid(LOCAL_DATA.tree || LOCAL_DATA);

  setupEdgeSwipe();
}

/* ===================== 返回逻辑（核心） ===================== */
function handleCustomBack(fromSystem = false) {
  if (currentMode !== 'grid') {
    closeReader();
    return;
  }

  if (historyStack.length > 0) {
    const parent = historyStack.pop();
    renderGrid(parent);
    return;
  }

  if (fromSystem) return;

  const now = Date.now();
  if (now - lastBackTime < 2000) {
    if (window.Capacitor?.Plugins?.App) {
      Capacitor.Plugins.App.exitApp();
    }
  } else {
    lastBackTime = now;
    alert('再按一次退出');
  }
}

/* ===================== 系统返回 ===================== */
window.addEventListener('popstate', () => {
  handleCustomBack(true);
});

/* ===================== 左滑返回 ===================== */
function setupEdgeSwipe() {
  const edge = document.getElementById('edge-swipe-handler');
  let startX = 0;

  edge.addEventListener('touchstart', e => {
    startX = e.touches[0].clientX;
  });

  edge.addEventListener('touchend', e => {
    const dx = e.changedTouches[0].clientX - startX;
    if (dx > 60) handleCustomBack();
  });
}

/* ===================== 渲染 ===================== */
function renderGrid(nodes) {
  currentMode = 'grid';
  document.getElementById('grid-view').style.display = 'block';
  document.getElementById('html-view').style.display = 'none';
  document.getElementById('pdf-view').style.display = 'none';

  const grid = document.getElementById('grid-view');
  grid.innerHTML = '';

  nodes.forEach(n => {
    const div = document.createElement('div');
    div.textContent = n.title || n.name;
    div.onclick = () => {
      if (n.children) {
        historyStack.push(nodes);
        safePush({ type:'folder' }, '#folder');
        renderGrid(n.children);
      } else {
        openFile(n.path, n.title);
      }
    };
    grid.appendChild(div);
  });
}

function openFile(path, title) {
  historyStack.push(null);
  safePush({ type:'reader' }, '#reader');
  document.getElementById('page-title').innerText = title;

  if (path.endsWith('.pdf')) {
    currentMode = 'pdf';
    document.getElementById('pdf-view').style.display = 'block';
    document.getElementById('grid-view').style.display = 'none';
  } else {
    currentMode = 'html';
    document.getElementById('html-view').style.display = 'block';
    document.getElementById('grid-view').style.display = 'none';
    fetch(path).then(r=>r.text()).then(t=>{
      document.getElementById('html-content').innerHTML=t;
      MathJax?.typeset();
    });
  }
}

function closeReader() {
  currentMode = 'grid';
  document.getElementById('html-view').style.display = 'none';
  document.getElementById('pdf-view').style.display = 'none';
  document.getElementById('grid-view').style.display = 'block';
}

/* ===================== 启动 ===================== */
initApp();
</script>

</body>
</html>
